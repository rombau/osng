var osApp=angular.module("OnlineSoccer",["ngRoute","ngSanitize","ngCookies","mobile-angular-ui","mobile-angular-ui.gestures"]);osApp.config(["$provide","$routeProvider","$locationProvider","$httpProvider",function(e,t,n,r){t.when("/",{template:"<login-component></login-component>"}).when("/index.html",{template:"<login-component></login-component>"}).when("/index.php",{template:"<login-component></login-component>"}).when("/haupt.php",{template:"<office-component></office-component>"}).when("/error",{template:'<div class="scrollable"><div class="scrollable-content"><div class="section"><span ng-bind-html="error"></span></div></div></div>'}).when("/zugabgabe.php",{template:"<move-component></move-component>"}).when("/trainer.php",{template:"<training-component></training-component>"}).when("/training.php",{template:"<training-component></training-component>"}).when("/player/:id",{template:function(e){return'<embedded-site site="../sp.php?s='+e.id+'"></embedded-site>'}}).when("/:site",{template:function(e){return'<embedded-site site="../'+e.site+'"></embedded-site>'}}).otherwise({template:'<div class="scrollable"><div class="scrollable-content"><div class="section">Unbekannte Seite!</div></div></div>'}),e.factory("ErrorInterceptor",["$rootScope","$location",function(e,t){return{responseError:function(n){e.error=""+n,t.path("error")}}}]),e.factory("LoadingInterceptor",[function(){var e=document.querySelector(".app-progress-indicator"),t=0;return{request:function(n){0===t&&angular.element(e).addClass("loading");var r=document.querySelector(".modal");return r&&angular.element(r).addClass("loading"),t++,n},requestError:function(e){return e},response:function(n){t--,0===t&&angular.element(e).removeClass("loading");var r=document.querySelector(".modal");return r&&angular.element(r).removeClass("loading"),n},responseError:function(n){t--,angular.element(e).removeClass("loading");var r=document.querySelector(".modal");return r&&angular.element(r).removeClass("loading"),n}}}]),r.interceptors.push("LoadingInterceptor"),r.interceptors.push("ErrorInterceptor")}]),osApp.filter("trustAsResourceUrl",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]),osApp.run(["$rootScope","Popup",function(e,t){e.$on("$locationChangeStart",function(n,r,o){!e.error&&t.hide()&&n.preventDefault()}),e.$on("mobile-angular-ui.state.changed.leftSwipe",function(e,n,r){n&&t.sidebar("leftSwipe")})}]),osApp.factory("Player",[function(){function e(e){this.id=0,this.name=e||"",this.pos="",this.alter=0,this.geburtstag=0,this.land="",this.flagge="",this.moral=0,this.fitness=0,this.skills=[],this.skill=0,this.opti=0,this.sonder="",this.gehalt=0,this.marktwert=0,this.vertrag=0,this.team=null}return e.Position={LEI:"LEI",TOR:"TOR",ABW:"ABW",DMI:"DMI",MIT:"MIT",OMI:"OMI",STU:"STU"},e.Skill={SCH:0,BAK:1,KOB:2,ZWK:3,DEC:4,GES:5,FUQ:6,ERF:7,AGG:8,PAS:9,AUS:10,UEB:11,WID:12,SEL:13,DIS:14,ZUV:15,EIN:16},e.prototype={getShortName:function(){for(var e=[" "," Van "," van "," De "," de "],t=this.name,n=this.name.length,r=0;r<e.length;r++){var o=this.name.lastIndexOf(e[r]);o>-1&&o<n&&(n=o)}return n!==this.name.length&&(t=this.name.substr(n+1)),t.replace(" ","&nbsp;")},isPrimarySkill:function(t){switch(this.pos){case e.Position.TOR:if(t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.DEC||t===e.Skill.GES)return!0;break;case e.Position.ABW:if(t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.DEC||t===e.Skill.ZUV)return!0;break;case e.Position.DMI:if(t===e.Skill.BAK||t===e.Skill.DEC||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.MIT:if(t===e.Skill.BAK||t===e.Skill.ZWK||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.OMI:if(t===e.Skill.BAK||t===e.Skill.GES||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.STU:if(t===e.Skill.SCH||t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.GES)return!0}return!1},getSkillCaption:function(t,n){switch(t){case e.Skill.SCH:return this.pos===e.Position.TOR?n?"ABS":"Abstoss":n?"SCH":"Schuss";case e.Skill.BAK:return this.pos===e.Position.TOR?n?"STS":"Stellungsspiel":n?"BAK":"Ballkontrolle";case e.Skill.KOB:return this.pos===e.Position.TOR?n?"FAN":"Fangsicherheit":n?"KOB":"Kopfball";case e.Skill.ZWK:return this.pos===e.Position.TOR?n?"STB":"Strafraumbeh.":n?"ZWK":"Zweikampf";case e.Skill.DEC:return this.pos===e.Position.TOR?n?"SPL":"Spiel auf der Linie":n?"DEC":"Deckung";case e.Skill.GES:return this.pos===e.Position.TOR?n?"REF":"Reflexe":n?"GES":"Geschwindigkeit";case e.Skill.FUQ:return n?"FUQ":"Führungsfertigkeit";case e.Skill.ERF:return n?"ERF":"Erfahrung";case e.Skill.AGG:return n?"AGG":"Aggressivität";case e.Skill.PAS:return n?"PAS":"Passgenauigkeit";case e.Skill.AUS:return n?"AUS":"Ausdauer";case e.Skill.UEB:return n?"UEB":"Übersicht";case e.Skill.WID:return n?"WID":"Widerstandskraft";case e.Skill.SEL:return n?"SEL":"Selbstbewusstsein";case e.Skill.DIS:return n?"DIS":"Disziplin";case e.Skill.ZUV:return n?"ZUV":"Zuverlässigkeit";case e.Skill.EIN:return n?"EIN":"Einstellung"}}},e}]),osApp.factory("Team",[function(){function e(){this.id=0,this.name="Demoteam",this.image="00000000.png",this.liga=0,this.liganame="",this.land="",this.player=[],this.otherId=null}return e.prototype={getFullName:function(){return this.name+" ("+this.liganame+" "+this.land+")"}},e}]),osApp.factory("Move",["Player",function(e){function t(){this.valid=!1,this.players=[],this.information={},this.information.zat=0,this.information.date=new Date,this.information.type="",this.information.home=!1,this.information.against={},this.information.against.id=0,this.information.against.name="",this.zats=[],this.options=[],this.Option=function(){this.page=0,this.item=0,this.text=""},this.adjustments=[],this.Adjustment=function(){this.option=new Option,this.id=0,this.text="",this.params={zao_einspieler:{},zao_spieler:{},zao_minute:{},zao_abhaengigkeit:{},P1:{},P2:{},P3:{},spieler_id:{}}}}return t.GRID_ROWS=15,t.GRID_COLUMNS=11,t.SET_PLAYER_INDICATOR=" ◉",t.SUBSTITUTE_INDICATOR=" ⇄",t.prototype={sortPlayers:function(){return this.players.length>0&&this.players.sort(function(t,n){var r=[e.Position.TOR,e.Position.ABW,e.Position.DMI,e.Position.MIT,e.Position.OMI,e.Position.STU],o=r.indexOf(n.pos)-r.indexOf(t.pos);return 0===o?n.opti-t.opti:o}),this.players},getStartPlayersAverage:function(e){for(var t=0,n=0,r=0;r<this.players.length;r++){var o=this.players[r];null!==o.row&&null!==o.col&&void 0!==o.row&&void 0!==o.col&&o.row>=0&&o[e]&&(t+=o[e],n++)}var i=Math.round(t/n*100)/100;return isNaN(i)?0:i},generateAdjustmentText:function(e){var t,n,r="",o=e.params.zao_abhaengigkeit.text;switch(o&&(n="in der "+e.params.zao_minute.text+". Minute","Immer durchführen"===o?o="Immer":-1!==(t=o.search(/ in/))?o=o.substring(0,t):-1!==(t=o.search(/ ab/))&&(o=o.substring(0,t),n="ab der "+e.params.zao_minute.text+". Minute")),e.option.item){case 1:r+=o,r+=" : ",r+=e.option.text,r+=" von ",r+=e.params.zao_einspieler.text,r+=" für ",r+=e.params.zao_spieler.text,r+=" ",r+=n,r+=" ",r+=e.params.P3.text||"auf Position "+e.params.P1.text+e.params.P2.text;break;case 5:r+=o,r+=" : ",r+=e.option.text,r+=" von ",r+=e.params.zao_spieler.text,r+=" auf Position ",r+=e.params.P1.text+e.params.P2.text,r+=" ",r+=n;break;case 6:r+=o,r+=" : ",r+="Positionsbezogen"===e.params.P1.text?"Positionsbezogene Manndeckung":"Manndeckung aufheben"===e.params.P1.text?"Manndeckung aufheben":"Manndeckung von "+e.params.P1.text,r+=" durch ",r+=e.params.zao_spieler.text,r+=" ",r+=n;break;case 2:case 3:case 4:r+=o,r+=" : ",r+=e.option.text,r+=" einstellen auf ",r+=e.params.P1.text,r+=" ",r+=n;break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:r=e.option.text+" : "+e.params.spieler_id.text;break;case 16:case 17:case 18:r+=o,r+=" : ",r+=n,r+=" ",r+=e.option.text.replace("Taktik","- Grundtaktik"),r+=" : ",r+=e.params.P1.text}return r}},t}]),osApp.factory("Training",[function(){function e(){this.config=[],this.Config=function(){this.id=0,this.label=""},this.trainer=[],this.players=[],this.Setting=function(){this.trainername=null,this.skillnr=1,this.skillvalue=null,this.chance=null}}return e.prototype={},e}]),osApp.factory("Account",["$http","$q","Team","HtmlUtil",function(e,t,n,r){var o=[],i={transformMain:function(e){var t,o,i=r.getEnsuredDocument(e),a=i.getElementsByTagName("img"),l=i.getElementsByTagName("b"),s=i.getElementsByTagName("a"),c=a[a.length-1],u=[new n];t=/images\/wappen\/((\d+)\.(png|gif))/gm,o=t.exec(c.src||c.outerHTML),o&&(u[0].id=+o[2],u[0].image=o[1]);for(var m=0;m<l.length;m++)l[m].textContent.search(/Willkommen im Managerb/)!==-1&&(u[0].name=l[m].textContent.split(" von ")[1]);for(var p=0;p<s.length;p++)if(t=/Zu ((\w+\s*)+) wechseln/gm,o=t.exec(s[p].textContent)){u.push(new n),u[1].name=o[1];break}return u},transformFirstTeam:function(e){for(var t=r.getEnsuredDocument(e),n=t.getElementsByTagName("a"),o=0;o<n.length;o++)if(n[o].textContent.search(/Mein (Zweit|Haupt)team/)!==-1)return r.extractIdFromHref(n[o].href);return null},transformSecondTeam:function(e){var t,n,o=r.getEnsuredDocument(e),i=o.getElementsByTagName("img"),a=i[0];return t=/images\/wappen\/((\d+)\.(png|gif))/gm,n=t.exec(a.src||a.outerHTML),n?n[1]:null},transformLoginValidation:function(e){var t=r.getEnsuredDocument(e),n=t.getElementsByTagName("p");if(n&&n.length&&n.length>0)throw n[n.length-1].textContent;return!0}},a=function(n){return t(function(t,r){e({url:"../haupt.php"+(n?"?changetosecond=true":""),method:"GET",transformResponse:i.transformMain}).then(function(a){n?t(o):(o=a.data,1===o.length?t(o):e({url:"../st.php?c="+o[0].id,method:"GET",transformResponse:i.transformFirstTeam}).then(function(n){if(n.data){var a=n.data;o[1].id=a,e({url:"../st.php?c="+o[1].id,method:"GET",transformResponse:i.transformSecondTeam}).then(function(e){e.data&&(o[1].image=e.data),t(o)},function(){r()})}},function(){r()}))},function(){r()})})},l=!1;return{clearTeams:function(){o=[]},getTeams:function(){return 0!==o.length||l||(l=!0,a().then(function(){l=!1})),o},toggleTeam:function(){return t(function(e,t){a(!0).then(function(){o.reverse(),e()},function(){t()})})},login:function(n,o){return t(function(t,a){e({url:"../validate.php",method:"POST",data:{action:"os_login",sdauer:0,loginemail:n,passwort:o},headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:r.encodeQueryParameters,transformResponse:i.transformLoginValidation}).then(function(e){t(e)},function(){a()})})}}}]),osApp.factory("Popup",["SharedState",function(e){var t=null;return{open:function(n,r){n&&(r?e.setOne(n,r):e.turnOn(n),t=n)},hide:function(){return!!t&&(e.turnOff(t),t=null,!0)},sidebar:function(e){e&&(t=e)}}}]),osApp.factory("HtmlUtil",["$injector",function(e){return{extractIdFromHref:function(e){if(e){if(e.search(/javascript:.+(\d+)/)!==-1)return+e.split("(")[1].split(")")[0];if(e.search(/sp\.php.+s=(\d+)/)!==-1)return+e.split("s=")[1].split("&")[0];if(e.search(/st\.php.+c=(\d+)/)!==-1)return+e.split("c=")[1].split("&")[0]}return null},getEnsuredDocument:function(t){if(!t)throw"Seite konnte nicht geladen werden.";var n,r;if(n=/F.+r die Dauer von ZAT (\d+) sind die Seiten von OS 2\.0 gesperrt!/gm,r=n.exec(t))throw r[0];if(n=/Diese Seite ist ohne Team nicht verf.+gbar!/gm,r=n.exec(t)){var o=e.get("Account");throw o&&o.clearTeams(),r[0]}return(new DOMParser).parseFromString(t,"text/html")},encodeQueryParameters:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+(null===e[n]?"":encodeURIComponent(e[n])));return t.join("&")}}}]),osApp.component("loginComponent",{templateUrl:"components/login/login.html",controller:["$location","Account",function(e,t){var n=this;n.loggedIn=!1,n.login=function(){t.login(n.email,n.password).then(function(r){r.data&&(n.loggedIn=!0,t.clearTeams(),e.path("/haupt.php"))})}}]});var MenuItem=function(e,t,n){this.id=e.replace(/\W/g,""),this.label=e,this.path=t,this.external=n||!1,this.items=[],this.addMenuItem=function(e){this.items.push(e)}};osApp.component("mainMenu",{templateUrl:"components/menu/menu.html",controller:["$http","$route","Account","SharedState",function(e,t,n,r){var o=this;o.menuItems=[],o.account=n,e({url:"../os_menu_haupt.html",method:"GET",transformResponse:function(e){for(var t,n=/m\((\d+)(?:,"([^"]+)")?(?:,"([^"]+)")?(?:,"([^"]+)")?.*\)/gm,r=[],o=n.exec(e);o;){var i=o[2].replace(/\s*\/\s*/," / "),a=(!o[4]||"os_main"!==o[4])&&"index.php"!==o[3],l=o[3]?a?o[3]:"#/"+o[3]:void 0;1===+o[1]?(t=new MenuItem(i,l,a),r.push(t)):t.addMenuItem(new MenuItem(i,l,a)),o=n.exec(e)}return r}}).then(function(e){o.menuItems=e.data}),o.handleItemClick=function(e){e.items.length>0?(r.get("submenu")===e.id&&r.isActive(e.id)?r.turnOff(e.id):r.turnOn(e.id),r.set("submenu",e.id)):r.turnOff("uiSidebarLeft")},o.getIconClass=function(e){return e.items.length>0?r.get("submenu")===e.id&&r.isActive(e.id)?"fa-chevron-circle-down":"fa-chevron-circle-right":"fa-caret-square-o-right"},o.changeToOtherTeam=function(){n.toggleTeam().then(function(){t.reload()})}}]}),osApp.component("embeddedSite",{templateUrl:"components/embedded/embedded.html",bindings:{site:"@",onLoad:"&"},controller:["$sce","Account",function(e,t){var n=this,r=document.querySelector(".app-progress-indicator");angular.element(r).addClass("loading"),window.embeddedLoaded=function(){angular.element(r).removeClass("loading");var e=this.document,o=e.body.textContent;o.indexOf("Demoteam")===-1&&o.indexOf("ohne Team")===-1||t.clearTeams(),n.onLoad()},e.trustAsResourceUrl(this.site)}]}),osApp.component("officeComponent",{templateUrl:"components/office/office.html",controller:["$document","$location",function(e,t){var n=this;n.onLoad=function(){for(var n=e[0].querySelector("#embeddedOffice #embedFrame").contentDocument,r=n.getElementsByTagName("a"),o=0;o<r.length;o++)r[o].href.indexOf("zugabgabe.php")!==-1&&(r[o].href=t.absUrl().split("#")[0]+"#/zugabgabe.php",r[o].target="_top",r[o].id="move")}}]}),osApp.factory("PlayerTransformation",["Player","Team","HtmlUtil",function(e,t,n){var r={transformPlayer:function(r){var o=new e,i=n.getEnsuredDocument(r),a=i.querySelector("img[alt=Face]");o.id=+a.src.split("faceprev.php?sid=")[1];var l=i.getElementsByTagName("table");o.name=l[0].rows[0].cells[2].textContent,o.alter=+l[0].rows[0].cells[5].textContent,o.gehalt=+l[0].rows[0].cells[8].textContent.match(/([\d|\.]+) EUR/)[1].replace(/\./g,""),o.land=l[0].rows[1].cells[1].textContent.trim(),o.flagge="/"+l[0].rows[1].cells[1].firstChild.getAttribute("src"),o.geburtstag=+l[0].rows[1].cells[4].textContent.substring(4),o.vertrag=+l[0].rows[1].cells[7].textContent,o.marktwert=+l[0].rows[2].cells[1].textContent.match(/([\d|\.]+) EUR/)[1].replace(/\./g,""),o.pos=l[0].rows[2].cells[4].textContent,o.verletzt=+l[0].rows[3].cells[1].textContent,o.team=new t;var s=l[0].rows[2].cells[7].childNodes;return o.team.id=n.extractIdFromHref(s[0].href),o.team.name=s[0].textContent,o.team.liga=+s[2].textContent.split(". Liga")[0],o.team.liganame=s[2].textContent.trim(),o.team.land=s[3].textContent,o.skill=+l[1].rows[0].cells[0].textContent.split(" : ")[1],o.opti=+l[1].rows[0].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.SCH]=+l[1].rows[1].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.BAK]=+l[1].rows[1].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.KOB]=+l[1].rows[1].cells[4].textContent.split(" : ")[1],o.skills[e.Skill.ZWK]=+l[1].rows[2].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.DEC]=+l[1].rows[2].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.GES]=+l[1].rows[2].cells[4].textContent.split(" : ")[1],o.skills[e.Skill.FUQ]=+l[1].rows[3].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.ERF]=+l[1].rows[3].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.AGG]=+l[1].rows[3].cells[4].textContent.split(" : ")[1],o.skills[e.Skill.PAS]=+l[1].rows[4].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.AUS]=+l[1].rows[4].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.UEB]=+l[1].rows[4].cells[4].textContent.split(" : ")[1],o.skills[e.Skill.WID]=+l[1].rows[5].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.SEL]=+l[1].rows[5].cells[2].textContent.split(" : ")[1],o.skills[e.Skill.DIS]=+l[1].rows[5].cells[4].textContent.split(" : ")[1],o.skills[e.Skill.ZUV]=+l[1].rows[6].cells[0].textContent.split(" : ")[1],o.skills[e.Skill.EIN]=+l[1].rows[6].cells[2].textContent.split(" : ")[1],o}};return r}]),osApp.factory("PlayerWebClient",["$http","Player","PlayerTransformation",function(e,t,n){return{loadPlayer:function(t){return e({url:"../sp.php?s="+t,method:"GET",transformResponse:n.transformPlayer})}}}]),osApp.component("player",{templateUrl:"components/player/player.html",bindings:{player:"<object"},controller:["PlayerWebClient",function(e){var t=this;e.loadPlayer(t.player.id).then(function(e){t.player=e.data})}]}),osApp.component("playerLink",{templateUrl:"components/player/player.link.html",bindings:{player:"<object"},controller:["Popup",function(e){var t=this;t.openPopup=function(){e.open("modalPlayer",t.player)}}]}),osApp.component("movablePlayer",{templateUrl:"components/player/player.movable.html",bindings:{player:"<object",dropAreaSelector:"<",onMove:"&",onRemove:"&"},controller:["$scope","$element","$document","$drag","$touch","$transform","$timeout","$interval","SharedState","Popup",function(e,t,n,r,o,i,a,l,s,c){var u=this,m=document.querySelectorAll(u.dropAreaSelector),p=t[0].firstChild,g=p.getBoundingClientRect(),f=function(){if(null===u.player.row&&null===u.player.col){var e=document.querySelector(".selection-container");if(e)return function(t){t?(angular.element(e).addClass("moving"),angular.element(p).addClass("moving")):(angular.element(e).removeClass("moving"),angular.element(p).removeClass("moving"))}}return function(e){e?(angular.element(p).addClass("moving"),angular.element(p.nextElementSibling).addClass("moving")):(angular.element(p).removeClass("moving"),angular.element(p.nextElementSibling).removeClass("moving"))}}(),d={navbar:51,area:document.querySelector(".scroll-area"),height:document.querySelector(".scroll-area").scrollHeight,slow:{margin:25,offset:5},fast:{margin:12,offset:10},interval:300,offset:0,promise:null},h=!1,v={transform:function(e,t,n){d.promise&&(l.cancel(d.promise),d.promise=null);var r=function(){for(var e=0;e<m.length;e++)if(m[e]){var r=m[e].getBoundingClientRect();if(n.x>r.left&&n.x<r.right&&n.y>r.top&&n.y<r.bottom){var o=n.x-r.left,i=n.y-r.top;return t.translateX=r.left+(o-o%g.width)-g.left,t.translateY=r.top+(i-i%g.height)-g.top,null!==u.player.row&&null!==u.player.col&&(t.translateY+=d.offset),t}}return t.translateX=n.distanceX,t.translateY=n.distanceY,null!==u.player.row&&null!==u.player.col&&(t.translateY+=d.offset),t},o=function(){var e=0;return window.innerHeight>2*d.slow.margin&&(n.y<d.navbar+d.slow.margin&&d.area.scrollTop>=d.slow.offset?e=n.y<d.navbar+d.fast.margin&&d.area.scrollTop>=d.fast.offset?-d.fast.offset:-d.slow.offset:n.y>window.innerHeight-d.slow.margin&&(e=n.y>window.innerHeight-d.fast.margin?d.fast.offset:d.slow.offset,d.area.scrollTop+e>d.height-d.area.clientHeight&&(e=d.height-d.area.clientHeight-d.area.scrollTop))),e},a=function(){var t=o();d.offset+=t,d.area.scrollTop+=t;var n=r();return i.set(e,n),n};return 0!==o()?(d.promise=l(a,d.interval),a()):r()},start:function(e,t){h=!0,f(!0),s.turnOff("leftSwipe"),d.offset=0},move:function(e,t){},cancel:function(e,t){f(!1),h=!1,l.cancel(d.promise),d.promise=null},end:function(t,n){for(var r=!1,o=0;o<m.length;o++)if(m[o]){var i=m[o].getBoundingClientRect();if(t.x>i.left&&t.x<i.right&&t.y>i.top&&t.y<i.bottom){var s=Math.floor((t.x-i.left)/g.width)+1,c=Math.floor((t.y-i.top)/g.height)+1;1===o?(s=0,c=0):2===o&&(s=(s-1)*-1,c=-1),u.onMove({player:u.player,x:s,y:c})&&t.reset(),r=!0}}r||(null!==u.player.row&&null!==u.player.col?u.onRemove({player:u.player})&&t.reset():t.reset()),a(function(){f(!1),h=!1,e.$apply()},100),l.cancel(d.promise),d.promise=null}};r.bind(p,v,{}),o.bind(p,{start:function(e){h||(g=p.getBoundingClientRect(),f(!0))},cancel:function(e){h||f(!1)},end:function(t){h||(f(!1),c.open("modalPlayer",u.player),e.$apply())}},{})}]}),osApp.factory("MoveTransformation",["Move","Player","HtmlUtil",function(e,t,n){var r={transformSetup:function(r){var o=new e,i=n.getEnsuredDocument(r),a=i.getElementsByTagName("table"),l=a[1].rows[0].cells[0],s=a[1].rows[0].cells[1],c=a[1].rows[0].cells[2],u=a[3],m=a[4],p=/ZA f.+r ZAT (\d+) Termin: \w+,* ([A-z]+ )*(\d+)\.[ ]*([\w|ä]+)[\.| ]*(\d\d\d\d)* ([A-z]+ )*(\d+)[\.|:](\d+)[\.|:]*(\d+)*/gm,g=p.exec(l.textContent);if(g){o.information.zat=+g[1];var f=g[3],d=+g[4]-1||["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"].indexOf(g[4]),h=g[5]||(new Date).getFullYear(),v=g[7],S=g[8],y=g[9]||0;o.information.date=new Date(h,d,f,v,S,y)}p=/(\w+) ([\w|ä]+) : <a href="javascript:teaminfo\((\d+)\)">(.*)<\/a>/gm,g=p.exec(s.innerHTML),g&&(o.information.type=g[1],o.information.home="Heim"===g[2],o.information.against={},o.information.against.id=+g[3],o.information.against.name=g[4]),o.valid=/Zugabgabe: G.+ltig/.test(c.textContent);var k,w,T,b=[];for(w=1;w<=e.GRID_ROWS;w++)for(k=u.rows[w],T=1;T<=e.GRID_COLUMNS;T++)b.push(k.cells[T].textContent);for(w=1;w<m.rows.length;w++)if(k=m.rows[w],9===k.cells.length){var x=new t;x.id=n.extractIdFromHref(k.cells[1].firstChild.href),x.name=k.cells[1].textContent,x.pos=k.cells[1].className,x.alter=+k.cells[2].textContent,x.moral=+k.cells[4].textContent,x.fitness=+k.cells[5].textContent,x.skill=+k.cells[6].textContent,x.opti=+k.cells[7].textContent,x.sonder=k.cells[8].textContent,x.col=null,x.row=null;var C=k.cells[0].firstChild.value;if("T"===C)x.col=0,x.row=0;else{var A=["V","W","X","Y","Z","U"].indexOf(C);if(A>=0)x.col=-A,x.row=-1;else{var E=b.indexOf(C);C&&E>=0&&(x.col=E%11+1,x.row=Math.floor(E/11)+1)}}o.players.push(x)}for(var P=i.getElementsByName("lauf")[0],I=0;I<P.options.length;I++){var O={};O.value=+P.options[I].value,O.label=P.options[I].text,O.value>0&&o.zats.push(O)}return o},transformActions:function(e){return r._transformOptions(e,1)},transformOptions:function(e){return r._transformOptions(e,2)},_transformOptions:function(t,r){for(var o,i=new e,a=n.getEnsuredDocument(t),l={},s=a.getElementsByTagName("select")[0],c=0;c<s.options.length;c++){var u=new i.Option;u.page=r,u.item=+s.options[c].value,u.text=s.options[c].text,u.item>0&&(i.options.push(u),o=u.text.split(" festlegen")[0].replace("schütze","").replace("Taktik","Grundtaktik"),l[o]=u)}for(var m=a.getElementsByTagName("table")[3],p=0;p<m.rows.length-1;p++){var g=m.rows[p],f=new i.Adjustment;f.id=+g.cells[0].firstChild.value,f.text=g.cells[1].textContent.replace(/ *: /g," : ");for(o in l)l.hasOwnProperty(o)&&f.text.search(o)!==-1&&(f.option=l[o]);i.adjustments.push(f)}return i},transformAdjustmentForm:function(t){for(var r={method:"GET",lines:[]},o=n.getEnsuredDocument(t),i=o.getElementsByTagName("table")[3],a=0;a<i.rows.length-1;a++){for(var l=i.rows[a],s=l.cells[0].getElementsByTagName("select").length>0,c={label:s?"":l.cells[0].textContent,combos:[]},u=l.cells[s?0:1].getElementsByTagName("select"),m=12,p=0;p<u.length;p++){for(var g=u[p],f={name:g.name,options:[]},d=0,h=0;h<g.options.length;h++){var v=g.options[h];d=Math.max(d,v.textContent.length),f.options.push({label:v.textContent.replace(/ \([A-T]\)/,e.SET_PLAYER_INDICATOR).replace(/ \([U-Z]\)/,e.SUBSTITUTE_INDICATOR),value:v.value})}f.width=d>2?d>5?m:3:2,f.value=g.value||f.options[0].value,c.combos.push(f),m-=f.width}r.lines.push(c)}return r},transformPlayers:function(e){var t,n=[],r=[];for(t=0;t<e.length;t++){var o=e[t];null!==o.row&&null!==o.col&&void 0!==o.row&&void 0!==o.col&&(n.push(["player_"+o.id,o.col,o.row]),o.row===-1&&(r[-o.col]=o))}if(n.length<17)for(t=0;t<6;t++)r[t]||n.push(["player_0",-t,-1]);return"aufstellung="+JSON.stringify(n)}};return r}]),osApp.factory("MoveWebClient",["$q","$http","Move","MoveTransformation",function(e,t,n,r){return{loadMove:function(n){var o;return t({url:"../zugabgabe.php"+(n?"?lauf="+n:""),method:"GET",transformResponse:r.transformSetup}).then(function(n){o=n.data;var i=e.defer(),a=[];return a.push(t({url:"../zugabgabe.php?p=1",method:"GET",transformResponse:r.transformActions})),a.push(t({url:"../zugabgabe.php?p=2",method:"GET",transformResponse:r.transformOptions})),e.all(a).then(function(e){o.options=e[0].data.options.concat(e[1].data.options),o.adjustments=e[0].data.adjustments.concat(e[1].data.adjustments),i.resolve(o)},i.reject,i.notify),i.promise})},saveMove:function(n){return t({url:"../zugabgabe_beta.php",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:n.players,transformRequest:r.transformPlayers}).then(function(r){var o=e.defer();if("Count mismatch"===r.data)return o.reject(r.data),o.promise;for(var i=[],a=0;a<n.adjustments.length;a++){var l=n.adjustments[a];if(!l.id||l.markDeleted){var s;if(l.markDeleted)s={p:l.option.page,delzae:l.id,delete:"++++Gewählte+Aktion+löschen+++"};else{s={p:l.option.page,itemcreate:l.option.item,anlegen:"+++Neue+Aktion+anlegen+++"};for(var c in l.params)l.params.hasOwnProperty(c)&&(s[c]=l.params[c].value)}i.push(t({url:"../zugabgabe.php",params:s,method:"GET"}))}}return e.all(i).then(function(e){t({url:"../checkza.php",method:"GET"}).then(o.resolve,o.reject,o.notify)},o.reject,o.notify),o.promise})},loadAdjustmentForm:function(e){return t({url:"../zugabgabe.php?p="+e.page+"&item="+e.item,method:"GET",transformResponse:r.transformAdjustmentForm})}}}]),osApp.component("moveComponent",{templateUrl:"components/move/move.html",controller:["$location","$window","SharedState","Popup","MoveWebClient","Move",function(e,t,n,r,o,i){var a=this;a.move=new i,a.adjustmentForm={};var l=6;a.grid=function(){for(var e=new Array(i.GRID_ROWS),t=0;t<i.GRID_ROWS;t++)e[t]=new Array(i.GRID_COLUMNS);return e}(),a.isPlayerSet=function(e){if(e)return null!==e.row&&null!==e.col&&void 0!==e.row&&void 0!==e.col;for(var t=0;t<a.move.players.length;t++)if(a.isPlayerSet(a.move.players[t]))return!0;return!1},a.grid.setPlayer=function(e,t,r){var o=null;return o=r>0?a.grid[r-1][t-1]:0===t&&0===r?a.getKeeper():a.getSubst()[-t],2===n.get("activeTab")?(r>0?e.row===-1?a.addAdjustment(a.move.options[0],function(n){a.adjustmentForm.lines[0].combos[0].value=""+e.id,o?(n.lines[1].combos[0].value=""+o.id,n.lines[4].combos[2].value="K"):(n.lines[4].combos[0].value=String.fromCharCode(65+(i.GRID_ROWS-r)),n.lines[4].combos[1].value=""+t)}):o||a.addAdjustment(a.move.options[4],function(n){n.lines[0].combos[0].value=""+e.id,n.lines[1].combos[0].value=String.fromCharCode(65+(i.GRID_ROWS-r)),n.lines[1].combos[1].value=""+t}):0===t&&0===r?e.row===-1&&a.addAdjustment(a.move.options[0],function(t){t.lines[0].combos[0].value=""+e.id,o&&(t.lines[1].combos[0].value=""+o.id),t.lines[4].combos[2].value="T"}):e.row!==-1&&a.addAdjustment(a.move.options[0],function(t){t.lines[1].combos[0].value=""+e.id,o&&(t.lines[0].combos[0].value=""+o.id),t.lines[4].combos[2].value="K"}),!0):(r>0&&(a.grid[r-1][t-1]=e),a.isPlayerSet(e)&&e.row>0&&(a.grid[e.row-1][e.col-1]=o),o&&(o.row=e.row,o.col=e.col),e.row=r,e.col=t,o)},a.grid.removePlayer=function(e){return 2===n.get("activeTab")||(a.isPlayerSet(e)&&e.row>0&&(a.grid[e.row-1][e.col-1]=null),e.row=null,e.col=null,!1)},a.getKeeper=function(){for(var e=0;e<a.move.players.length;e++){var t=a.move.players[e];if(0===t.row&&0===t.col)return t}return null},a.getSubst=function(){for(var e=new Array(l),t=0;t<a.move.players.length;t++){var n=a.move.players[t];n.row===-1&&(e[-n.col]=n)}return e},a.getAdjustments=function(){for(var e=[],t=0;t<a.move.adjustments.length;t++){var n=a.move.adjustments[t];!n.id&&n.markDeleted||e.push(n)}return e.length>0&&e.sort(function(e,t){return e.option.item-t.option.item}),e},a.addAdjustment=function(e,t){o.loadAdjustmentForm(e).then(function(n){if(n.data&&n.data.lines){a.option=e,a.adjustmentForm=n.data;var o=[];o[i.SET_PLAYER_INDICATOR]=[],o[i.SUBSTITUTE_INDICATOR]=[];for(var l=0;l<a.move.players.length;l++){var s=a.move.players[l];s.row===-1?o[i.SUBSTITUTE_INDICATOR].push(s.name):a.isPlayerSet(s)&&o[i.SET_PLAYER_INDICATOR].push(s.name)}for(var c=0;c<a.adjustmentForm.lines.length;c++)for(var u=a.adjustmentForm.lines[c],m=0;m<u.combos.length;m++)for(var p=u.combos[m],g=0;g<p.options.length;g++){var f=p.options[g];o[i.SET_PLAYER_INDICATOR].indexOf(f.label)>=0?f.label+=i.SET_PLAYER_INDICATOR:o[i.SUBSTITUTE_INDICATOR].indexOf(f.label)>=0&&(f.label+=i.SUBSTITUTE_INDICATOR)}t&&t(a.adjustmentForm),r.open("moveAction")}})},a.removeAdjustment=function(e){e.markDeleted=!e.markDeleted},a.saveAdjustment=function(){var e=new i,t=new e.Adjustment;t.option.item=a.option.item,t.option.page=a.option.page,t.option.text=a.option.text;for(var n=0;n<a.adjustmentForm.lines.length;n++)for(var r=a.adjustmentForm.lines[n],o=0;o<r.combos.length;o++){for(var l,s=r.combos[o],c=0;c<s.options.length;c++){var u=s.options[c];if(u.value===s.value){l=u.label.replace(i.SET_PLAYER_INDICATOR,"").replace(i.SUBSTITUTE_INDICATOR,"");break}}t.params[s.name]={value:s.value,text:l}}t.text=e.generateAdjustmentText(t),a.move.adjustments.push(t)};var s=function(e){a.move=e,a.move.players=e.sortPlayers();for(var t=0;t<a.move.players.length;t++){var n=a.move.players[t];n.row>0&&n.col>0&&(a.grid[n.row-1][n.col-1]=n)}};a.save=function(){for(var e=0,n=0;n<a.move.players.length;n++){var i=a.move.players[n];a.isPlayerSet(i)&&i.row>=0&&e++}e<11?t.alert("Es ist (vorläufig) nicht möglich die Zugabgabe zu speichern, solange nicht 11 Spieler aufgestellt sind!"):o.saveMove(a.move).then(function(){o.loadMove().then(s),r.open("moveCheck")})},a.load=function(e){return e?(o.loadMove(a.zat).then(s),void(a.zat=null)):(a.zat=a.move.zats[0].value,void r.open("moveLoad"))},o.loadMove().then(s)}]}),osApp.factory("TrainingTransformation",["Training","Trainer","Player","HtmlUtil",function(e,t,n,r){var o={transformTrainer:function(e){for(var n=[],o=r.getEnsuredDocument(e),i=o.getElementsByTagName("table")[0],a=1;a<i.rows.length;a++){var l=i.rows[a];if(5===l.cells.length){var s=new t;s.name=l.cells[1].textContent,s.skill=t.SKILLS[s.name.split(" ")[1]-1],s.gehalt=+l.cells[2].textContent.replace(/\./g,""),s.vertrag=+l.cells[3].textContent;var c=/und ([\d+|\.]+) Euro Abfindung zahlen!/gm,u=c.exec(l.cells[4].textContent);u&&(s.abfindung=+u[1].replace(/\./g,"")),n.push(s)}}return n},transformTraining:function(o){for(var i=new e,a=r.getEnsuredDocument(o),l=a.getElementsByName("trainingload")[0],s=1;s<l.options.length;s++){var c=new i.Config;c.id=+l.options[s].value,c.label=l.options[s].text,i.config.push(c)}for(var u=a.getElementsByTagName("table")[2],m=1;m<u.rows.length;m++){var p=u.rows[m];if(8===p.cells.length){var g=new n;g.id=r.extractIdFromHref(p.cells[1].firstChild.href),g.verletzt=p.cells[0].childNodes.length>0,g.name=p.cells[1].textContent,g.pos=p.cells[1].className,g.alter=+p.cells[2].textContent,g.opti=+p.cells[3].textContent;var f=a.getElementsByName("tr1"+g.id)[0],d=a.getElementsByName("tr2"+g.id)[0];if(1===m)for(var h=1;h<f.options.length;h++){var v=/T (\d) ([\d|\.]+)/gm,S=v.exec(f.options[h].text);if(S){var y=t.SKILLS.indexOf(+S[2])+1;i.trainer[h-1]=new t(y)}}"0"===f.value||"0"===d.value||g.verletzt||(i.trainer[f.value-1].players+=1,g.setting=new i.Setting,g.setting.trainerkey=i.trainer[f.value-1].getKey(),g.setting.skillnr=+d.value,g.setting.skillvalue=+p.cells[6].textContent,g.setting.chance=+p.cells[7].textContent.split(" %")[0]),i.players.push(g)}}return i}};return o}]),osApp.factory("TrainingWebClient",["$q","$http","Training","TrainingTransformation",function(e,t,n,r){return{loadTraining:function(){var n=e.defer(),o=[];return o.push(t({url:"../training.php",method:"GET",transformResponse:r.transformTraining})),o.push(t({url:"../trainer.php",method:"GET",transformResponse:r.transformTrainer})),e.all(o).then(function(e){for(var t=e[0].data,r=0;r<t.trainer.length;r++)t.trainer[r].gehalt+=e[1].data[r].gehalt,t.trainer[r].vertrag=e[1].data[r].vertrag,t.trainer[r].abfindung=e[1].data[r].abfindung;n.resolve(t)},n.reject,n.notify),n.promise},saveTraining:function(){}}}]),osApp.component("trainingComponent",{
templateUrl:"components/training/training.html",controller:["TrainingWebClient","Training","Trainer","Player","Popup",function(e,t,n,r,o){var i=this;i.training=new t;var a=function(e){i.training=e};e.loadTraining().then(a),i.save=function(){},i.load=function(e){o.open("trainingLoad")},i.addPlayerSetting=function(e){e.setting=new i.training.Setting,e.setting.trainerkey=i.training.trainer[0].getKey(),i.changeTrainerSelection()},i.editPlayerSetting=function(e){i.dialog={player:e,setting:new i.training.Setting},e.setting?(i.dialog.setting.trainerkey=e.setting.trainerkey,i.dialog.setting.skillnr=e.setting.skillnr):i.dialog.setting.trainerkey=i.training.trainer[0].getKey(),o.open("trainingsetting",e)},i.savePlayerSetting=function(){i.dialog.player.setting||(i.dialog.player.setting=new i.training.Setting),i.dialog.player.setting.trainerkey!==i.dialog.setting.trainerkey&&(i.dialog.player.setting.trainerkey=i.dialog.setting.trainerkey,i.dialog.player.setting.chance=null,i.changeTrainerSelection()),i.dialog.player.setting.skillnr!==i.dialog.setting.skillnr&&(i.dialog.player.setting.skillnr=i.dialog.setting.skillnr,i.dialog.player.setting.chance=null)},i.deletePlayerSetting=function(e){e?delete e.setting:(delete i.dialog.player.setting,o.hide()),i.changeTrainerSelection()},i.openPlayer=function(e){o.open("modalPlayer",e)},i.changeTrainerSelection=function(){delete i.trainerSelection},i.getTrainerSelection=function(e){if(!i.trainerSelection&&i.training.trainer.length>0&&i.training.players.length>0){for(var t,r={},o=0;o<i.training.trainer.length;o++)t=i.training.trainer[o].getKey(),r[t]?r[t].max+=n.MAX_PLAYERS:r[t]=new n(t);for(var a=0;a<i.training.players.length;a++){var l=i.training.players[a].setting;l&&l.trainerkey&&r[l.trainerkey].players++}i.trainerSelection=[];for(t in r)r.hasOwnProperty(t)&&i.trainerSelection.push(r[t]);i.trainerSelection.sort(function(e,t){return t.skill-e.skill})}return i.trainerSelection},i.getPlayerSkillSelection=function(e){if(!e.trainingskillSelection){e.trainingskillSelection=[];var t=1;for(var n in r.Skill)if(r.Skill.hasOwnProperty(n)){var o=r.Skill[n];if(o===r.Skill.FUQ||o===r.Skill.ERF||o===r.Skill.WID||o===r.Skill.SEL||o===r.Skill.DIS||o===r.Skill.EIN)continue;var i=e.getSkillCaption(o);e.setting&&e.setting.skillnr===t&&e.setting.skillvalue?i=i+" (="+e.setting.skillvalue+")":e.skills[o]&&(i=i+" (="+e.skills[o]+")"),e.trainingskillSelection.push({nr:t++,index:o,label:i,value:e.skills[o]})}}return e.trainingskillSelection},i.getPlayerSkillName=function(e,t){for(var n=i.getPlayerSkillSelection(e),r=0;r<n.length;r++){var o=n[r];if(o.nr===e.setting.skillnr)return e.getSkillCaption(o.index,t)}return null}}]});