var osApp=angular.module("OnlineSoccer",["ngRoute","ngSanitize","ngCookies","mobile-angular-ui","mobile-angular-ui.gestures"]);osApp.value("UserData",{loggedIn:!1,teamName:"Demoteam",teamImage:"00000000.png",error:""}),osApp.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,n){e.when("/",{template:"<login-form></login-form>"}).when("/index.html",{template:"<login-form></login-form>"}).when("/index.php",{template:"<login-form></login-form>"}).when("/error",{template:'<div class="scrollable"><div class="scrollable-content"><div class="section"><span ng-bind-html="error"></span></div></div></div>'}).when("/zugabgabe.php",{template:"<move-component></move-component>"}).when("/player/:id",{template:function(e){return'<embedded-site site="../sp.php?s='+e.id+'"></embedded-site>'}}).when("/:site",{template:function(e){return'<embedded-site site="../'+e.site+'"></embedded-site>'}}).otherwise({template:'<div class="scrollable"><div class="scrollable-content"><div class="section">Unbekannte Seite!</div></div></div>'}),n.interceptors.push(["$rootScope","$location",function(e,t){var n=document.querySelector(".app-progress-indicator"),o=0;return{request:function(e){return 0===o&&angular.element(n).addClass("loading"),o++,e},requestError:function(e){return e},response:function(e){return o--,0===o&&angular.element(n).removeClass("loading"),e},responseError:function(r){return o--,angular.element(n).removeClass("loading"),e.error=""+r,t.path("error"),r}}}])}]),osApp.controller("MainController",["$scope","UserData",function(e,t){e.userData=t}]),osApp.filter("trustAsResourceUrl",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]),osApp.component("playerLink",{template:'<a ng-click="$ctrl.openWindow()" class="{{$ctrl.player.pos}} noselect">{{$ctrl.player.name}}</a>',bindings:{player:"<object"},controller:["$window",function(e){var t=this;t.openWindow=function(){return e.open("../sp.php?s="+t.player.id,"os_spieler","toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=no,copyhistory=yes,width=800,height=550"),!1}}]});var osApp=osApp||angular.module("OnlineSoccer");osApp.component("embeddedSite",{templateUrl:"templates/embedded.html",controller:["$sce",function(e){var t=document.querySelector(".app-progress-indicator");angular.element(t).addClass("loading"),window.embeddedLoaded=function(){angular.element(t).removeClass("loading")},e.trustAsResourceUrl(this.site)}],bindings:{site:"@"}});var osApp=osApp||angular.module("OnlineSoccer");osApp.component("loginForm",{templateUrl:"templates/login.html",controller:["$http","$location","UserData",function(e,t,n){var o=this;this.email=null,this.password=null,this.inProgress=!1,this.failureMsg=null,this.login=function(){this.inProgress=!0,e({url:"../validate.php",method:"POST",transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+(null===e[n]?"":encodeURIComponent(e[n])));return t.join("&")},data:{action:"os_login",sdauer:0,loginemail:o.email,passwort:o.password},headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){var r=(new DOMParser).parseFromString(e.data,"text/html"),a=r.getElementsByTagName("p");a&&a.length&&a.length>0?o.failureMsg=a[a.length-1].textContent:(n.loggedIn=!0,n.teamImage="00000019.png",t.path("/haupt.php")),o.inProgress=!1},function(e){})}}]});var osApp=osApp||angular.module("OnlineSoccer"),MenuItem=function(e,t,n){this.id=e.replace(/\W/g,""),this.label=e,this.path=t,this.external=n||!1,this.items=[],this.addMenuItem=function(e){this.items.push(e)}};osApp.component("mainMenu",{templateUrl:"templates/menu.html",controller:["$http","UserData","SharedState",function(e,t,n){var o=this;this.menuItems=[],this.user=t,e({url:"../os_menu_haupt.html",method:"GET",transformResponse:function(e){for(var t,n=/m\((\d+)(?:,"([^"]+)")?(?:,"([^"]+)")?(?:,"([^"]+)")?.*\)/gm,o=[],r=n.exec(e);r;){var a=r[2].replace(/\s*\/\s*/," / "),s=(!r[4]||"os_main"!==r[4])&&"index.php"!==r[3],i=r[3]?s?r[3]:"#/"+r[3]:void 0;1===+r[1]?(t=new MenuItem(a,i,s),o.push(t)):t.addMenuItem(new MenuItem(a,i,s)),r=n.exec(e)}return o}}).then(function(e){o.menuItems=e.data},function(e){}),this.handleItemClick=function(e){e.items.length>0?(n.get("submenu")===e.id&&n.isActive(e.id)?n.turnOff(e.id):n.turnOn(e.id),n.set("submenu",e.id)):n.turnOff("uiSidebarLeft")},this.getIconClass=function(e){return e.items.length>0?n.get("submenu")===e.id&&n.isActive(e.id)?"fa-chevron-circle-down":"fa-chevron-circle-right":"fa-caret-square-o-right"}}]});var osApp=osApp||angular.module("OnlineSoccer");osApp.factory("Player",[function(){function e(){this.id=0,this.name="",this.pos="",this.alter=0,this.moral=0,this.fitness=0,this.skill=0,this.opti=0,this.sonder=""}return e.Positions=["TOR","ABW","DMI","MIT","OMI","STU"],e.prototype={getShortName:function(){var e=this.name.split(" ");return e[e.length-1]}},e}]),osApp.factory("HtmlTransformationUtil",[function(){return{extractIdFromHref:function(e){if(e){if(e.search(/javascript:.+(\d+)/)!==-1)return+e.split("(")[1].split(")")[0];if(e.search(/sp\.php.+s=(\d+)/)!==-1)return+e.split("s=")[1].split("&")[0];if(e.search(/st\.php.+c=(\d+)/)!==-1)return+e.split("c=")[1].split("&")[0]}return null},getEnsuredDocument:function(e){var t,n;if(t=/F.+r die Dauer von ZAT (\d+) sind die Seiten von OS 2\.0 gesperrt!/gm,n=t.exec(e))throw n[0];if(t=/Diese Seite ist ohne Team nicht verf.+gbar!/gm,n=t.exec(e))throw n[0];return(new DOMParser).parseFromString(e,"text/html")}}}]),osApp.factory("Move",["Player",function(e){function t(){this.valid=!1,this.players=[],this.information={},this.information.zat=0,this.information.date=new Date,this.information.type="",this.information.home=!1,this.information.against={},this.information.against.id=0,this.information.against.name="",this.options=[],this.Option=function(){this.page=0,this.item=0,this.text=""},this.adjustments=[],this.Adjustment=function(){this.option=new Option,this.id=0,this.text="",this.params={zao_einspieler:{},zao_spieler:{},zao_minute:{},zao_abhaengigkeit:{},P1:{},P2:{},P3:{},spieler_id:{}}}}return t.GRID_ROWS=15,t.GRID_COLUMNS=11,t.SET_PLAYER_INDICATOR=" ◉",t.SUBSTITUTE_INDICATOR=" ⇄",t.prototype={sortPlayers:function(){return this.players.length>0&&this.players.sort(function(t,n){var o=e.Positions.indexOf(n.pos)-e.Positions.indexOf(t.pos);return 0===o?n.opti-t.opti:o}),this.players},generateAdjustmentText:function(e){var t,n,o="",r=e.params.zao_abhaengigkeit.text;switch(r&&(n="in der "+e.params.zao_minute.text+". Minute","Immer durchführen"===r?r="Immer":-1!==(t=r.search(/ in/))?r=r.substring(0,t):-1!==(t=r.search(/ ab/))&&(r=r.substring(0,t),n="ab der "+e.params.zao_minute.text+". Minute")),e.option.item){case 1:o+=r,o+=" : ",o+=e.option.text,o+=" von ",o+=e.params.zao_einspieler.text,o+=" für ",o+=e.params.zao_spieler.text,o+=" ",o+=n,o+=" ",o+=e.params.P3.text||"auf Position "+e.params.P1.text+e.params.P2.text;break;case 5:o+=r,o+=" : ",o+=e.option.text,o+=" von ",o+=e.params.zao_spieler.text,o+=" auf Position ",o+=e.params.P1.text+e.params.P2.text,o+=" ",o+=n;break;case 6:o+=r,o+=" : ",o+="Positionsbezogen"===e.params.P1.text?"Positionsbezogene Manndeckung":"Manndeckung aufheben"===e.params.P1.text?"Manndeckung aufheben":"Manndeckung von "+e.params.P1.text,o+=" durch ",o+=e.params.zao_spieler.text,o+=" ",o+=n;break;case 2:case 3:case 4:o+=r,o+=" : ",o+=e.option.text,o+=" einstellen auf ",o+=e.params.P1.text,o+=" ",o+=n;break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:o=e.option.text+" : "+e.params.spieler_id.text;break;case 16:case 17:case 18:o+=r,o+=" : ",o+=n,o+=" ",o+=e.option.text.replace("Taktik","- Grundtaktik"),o+=" : ",o+=e.params.P1.text}return o}},t}]),osApp.factory("MoveTransformation",["Move","Player","HtmlTransformationUtil",function(e,t,n){var o={transformSetup:function(o){var r=new e,a=n.getEnsuredDocument(o),s=a.getElementsByTagName("table"),i=s[1].rows[0].cells[0],l=s[1].rows[0].cells[1],u=s[1].rows[0].cells[2],m=s[3],p=s[4],c=/ZA f.+r ZAT (\d+) Termin: \w+, ([A-z]+ )*(\d+)\.[ ]*([\w|ä]+)[\.| ]*(\d\d\d\d) ([A-z]+ )*(\d+):(\d+):*(\d+)*/gm,d=c.exec(i.textContent);if(d){r.information.zat=+d[1];var f=d[3],h=+d[4]-1||["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"].indexOf(d[4]),g=d[5],v=d[7],b=d[8],y=d[9]||0;r.information.date=new Date(g,h,f,v,b,y)}c=/(\w+) ([\w|ä]+) : <a href="javascript:teaminfo\((\d+)\)">(.*)<\/a>/gm,d=c.exec(l.innerHTML),d&&(r.information.type=d[1],r.information.home="Heim"===d[2],r.information.against={},r.information.against.id=+d[3],r.information.against.name=d[4]),r.valid=/Zugabgabe: G.+ltig/.test(u.textContent);var w,x,A,T=[];for(x=1;x<=e.GRID_ROWS;x++)for(w=m.rows[x],A=1;A<=e.GRID_COLUMNS;A++)T.push(w.cells[A].textContent);for(x=1;x<p.rows.length;x++)if(w=p.rows[x],9===w.cells.length){var S=new t;S.id=n.extractIdFromHref(w.cells[1].firstChild.href),S.name=w.cells[1].textContent,S.pos=w.cells[1].className,S.alter=+w.cells[2].textContent,S.moral=+w.cells[4].textContent,S.fitness=+w.cells[5].textContent,S.skill=+w.cells[6].textContent,S.opti=+w.cells[7].textContent,S.sonder=w.cells[8].textContent,S.col=null,S.row=null;var C=w.cells[0].firstChild.value;if("T"===C)S.col=0,S.row=0;else{var I=["V","W","X","Y","Z","U"].indexOf(C);if(I>=0)S.col=-I,S.row=-1;else{var O=T.indexOf(C);C&&O>=0&&(S.col=O%11+1,S.row=Math.floor(O/11)+1)}}r.players.push(S)}return r},transformActions:function(e){return o._transformOptions(e,1)},transformOptions:function(e){return o._transformOptions(e,2)},_transformOptions:function(t,o){for(var r,a=new e,s=n.getEnsuredDocument(t),i={},l=s.getElementsByTagName("select")[0],u=0;u<l.options.length;u++){var m=new a.Option;m.page=o,m.item=+l.options[u].value,m.text=l.options[u].text,m.item>0&&(a.options.push(m),r=m.text.split(" festlegen")[0].replace("schütze","").replace("Taktik","Grundtaktik"),i[r]=m)}for(var p=s.getElementsByTagName("table")[3],c=0;c<p.rows.length-1;c++){var d=p.rows[c],f=new a.Adjustment;f.id=+d.cells[0].firstChild.value,f.text=d.cells[1].textContent.replace(/ *: /g," : ");for(r in i)i.hasOwnProperty(r)&&f.text.search(r)!==-1&&(f.option=i[r]);a.adjustments.push(f)}return a},transformAdjustmentForm:function(t){for(var o={method:"GET",lines:[]},r=n.getEnsuredDocument(t),a=r.getElementsByTagName("table")[3],s=0;s<a.rows.length-1;s++){for(var i=a.rows[s],l=i.cells[0].getElementsByTagName("select").length>0,u={label:l?"":i.cells[0].textContent,combos:[]},m=i.cells[l?0:1].getElementsByTagName("select"),p=12,c=0;c<m.length;c++){for(var d=m[c],f={name:d.name,options:[]},h=0,g=0;g<d.options.length;g++){var v=d.options[g];h=Math.max(h,v.textContent.length),f.options.push({label:v.textContent.replace(/ \([A-T]\)/,e.SET_PLAYER_INDICATOR).replace(/ \([U-Z]\)/,e.SUBSTITUTE_INDICATOR),value:v.value})}f.width=h>2?h>5?p:3:2,f.value=d.value||f.options[0].value,u.combos.push(f),p-=f.width}o.lines.push(u)}return o}};return o}]),osApp.factory("MoveWebClient",["$q","$http","Move","MoveTransformation",function(e,t,n,o){return{loadMove:function(n){var r;return t({url:"../zugabgabe.php"+(n?"?lauf="+n:""),method:"GET",transformResponse:o.transformSetup}).then(function(n){r=n.data;var a=e.defer(),s=[];return s.push(t({url:"../zugabgabe.php?p=1",method:"GET",transformResponse:o.transformActions})),s.push(t({url:"../zugabgabe.php?p=2",method:"GET",transformResponse:o.transformOptions})),e.all(s).then(function(e){r.options=e[0].data.options.concat(e[1].data.options),r.adjustments=e[0].data.adjustments.concat(e[1].data.adjustments),a.resolve(r)},a.reject,a.notify),a.promise})},saveMove:function(e){return t({url:"../zugabgabe-beta.php",method:"POST"})},loadAdjustmentForm:function(e){return t({url:"../zugabgabe.php?p="+e.page+"&item="+e.item,method:"GET",transformResponse:o.transformAdjustmentForm})}}}]),osApp.component("moveComponent",{templateUrl:"templates/move.html",controller:["$location","$window","SharedState","MoveWebClient","Move",function(e,t,n,o,r){var a=this;a.players=[],a.options=[],a.adjustments=[];var s=6;a.grid=function(){for(var e=new Array(r.GRID_ROWS),t=0;t<r.GRID_ROWS;t++)e[t]=new Array(r.GRID_COLUMNS);return e}(),a.isPlayerSet=function(e){if(e)return null!==e.row&&null!==e.col&&void 0!==e.row&&void 0!==e.col;for(var t=0;t<a.players.length;t++)if(a.isPlayerSet(a.players[t]))return!0;return!1},a.grid.setPlayer=function(e,t,o){var s=null;return s=o>0?a.grid[o-1][t-1]:0===t&&0===o?a.getKeeper():a.getSubst()[-t],2===n.get("activeTab")?(o>0?e.row===-1?a.addAdjustment(a.options[0],function(n){a.adjustmentForm.lines[0].combos[0].value=""+e.id,s?(n.lines[1].combos[0].value=""+s.id,n.lines[4].combos[2].value="K"):(n.lines[4].combos[0].value=String.fromCharCode(65+(r.GRID_ROWS-o)),n.lines[4].combos[1].value=""+t)}):s||a.addAdjustment(a.options[4],function(n){n.lines[0].combos[0].value=""+e.id,n.lines[1].combos[0].value=String.fromCharCode(65+(r.GRID_ROWS-o)),n.lines[1].combos[1].value=""+t}):0===t&&0===o?e.row===-1&&a.addAdjustment(a.options[0],function(t){t.lines[0].combos[0].value=""+e.id,s&&(t.lines[1].combos[0].value=""+s.id),t.lines[4].combos[2].value="T"}):e.row!==-1&&a.addAdjustment(a.options[0],function(t){t.lines[1].combos[0].value=""+e.id,s&&(t.lines[0].combos[0].value=""+s.id),t.lines[4].combos[2].value="K"}),!0):(o>0&&(a.grid[o-1][t-1]=e),a.isPlayerSet(e)&&e.row>0&&(a.grid[e.row-1][e.col-1]=s),s&&(s.row=e.row,s.col=e.col),e.row=o,e.col=t,s)},a.grid.removePlayer=function(e){return 2===n.get("activeTab")||(a.isPlayerSet(e)&&e.row>0&&(a.grid[e.row-1][e.col-1]=null),e.row=null,e.col=null,!1)},a.getKeeper=function(){for(var e=0;e<a.players.length;e++){var t=a.players[e];if(0===t.row&&0===t.col)return t}return null},a.getSubst=function(){for(var e=new Array(s),t=0;t<a.players.length;t++){var n=a.players[t];n.row===-1&&(e[-n.col]=n)}return e},a.getAdjustments=function(){for(var e=[],t=0;t<a.adjustments.length;t++){var n=a.adjustments[t];!n.id&&n.markDeleted||e.push(n)}return e.length>0&&e.sort(function(e,t){return e.option.item-t.option.item}),e},a.addAdjustment=function(e,t){o.loadAdjustmentForm(e).then(function(o){if(o.data&&o.data.lines){a.option=e,a.adjustmentForm=o.data;var s=[];s[r.SET_PLAYER_INDICATOR]=[],s[r.SUBSTITUTE_INDICATOR]=[];for(var i=0;i<a.players.length;i++){var l=a.players[i];l.row===-1?s[r.SUBSTITUTE_INDICATOR].push(l.name):a.isPlayerSet(l)&&s[r.SET_PLAYER_INDICATOR].push(l.name)}for(var u=0;u<a.adjustmentForm.lines.length;u++)for(var m=a.adjustmentForm.lines[u],p=0;p<m.combos.length;p++)for(var c=m.combos[p],d=0;d<c.options.length;d++){var f=c.options[d];s[r.SET_PLAYER_INDICATOR].indexOf(f.label)>=0?f.label+=r.SET_PLAYER_INDICATOR:s[r.SUBSTITUTE_INDICATOR].indexOf(f.label)>=0&&(f.label+=r.SUBSTITUTE_INDICATOR)}t&&t(a.adjustmentForm),n.turnOn("action")}})},a.removeAdjustment=function(e){e.markDeleted=!e.markDeleted},a.saveAdjustment=function(){var e=new r,t=new e.Adjustment;t.option.item=a.option.item,t.option.page=a.option.page,t.option.text=a.option.text;for(var n=0;n<a.adjustmentForm.lines.length;n++)for(var o=a.adjustmentForm.lines[n],s=0;s<o.combos.length;s++){for(var i,l=o.combos[s],u=0;u<l.options.length;u++){var m=l.options[u];if(m.value===l.value){i=m.label.replace(r.SET_PLAYER_INDICATOR,"").replace(r.SUBSTITUTE_INDICATOR,"");break}}t.params[l.name]={value:l.value,text:i}}t.text=e.generateAdjustmentText(t),a.adjustments.push(t)},a.save=function(){console.log("SAVE: "+JSON.stringify(a.players)),t.open("../checkza.php","checkza","toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,copyhistory=yes,height=600,width=400")};var i=function(e){a.valid=e.valid,a.information=e.information,a.players=e.sortPlayers(),a.options=e.options,a.adjustments=e.adjustments;for(var t=0;t<a.players.length;t++){var n=a.players[t];n.row>0&&n.col>0&&(a.grid[n.row-1][n.col-1]=n)}};a.load=function(e){return e?(o.loadMove(a.zat).then(i),void(a.zat=null)):(a.zat="1",void n.turnOn("load"))},o.loadMove().then(i)}]}),osApp.component("player",{templateUrl:"templates/gridplayer.html",bindings:{player:"<object",onMove:"&",onRemove:"&"},controller:["$scope","$element","$document","$drag","$touch","$timeout","SharedState",function(e,t,n,o,r,a,s){var i=this,l=[];l.push(document.querySelector(".grid-container")),l.push(document.querySelector(".keeper-container")),l.push(document.querySelector(".subst-container"));var u=t[0].firstChild,m=u.getBoundingClientRect(),p=function(){if(null===i.player.row&&null===i.player.col){var e=document.querySelector(".selection-container");if(e)return function(t){t?(angular.element(e).addClass("moving"),angular.element(u).addClass("moving")):(angular.element(e).removeClass("moving"),angular.element(u).removeClass("moving"))}}return function(e){e?(angular.element(u).addClass("moving"),angular.element(u.nextElementSibling).addClass("moving")):(angular.element(u).removeClass("moving"),angular.element(u.nextElementSibling).removeClass("moving"))}}(),c=!1,d={transform:function(e,t,n){for(var o=0;o<l.length;o++)if(l[o]){var r=l[o].getBoundingClientRect();if(n.x>r.left&&n.x<r.right&&n.y>r.top&&n.y<r.bottom)return t.translateX=r.left+(n.x-r.left-(n.x-r.left)%m.width)-m.left,t.translateY=r.top+(n.y-r.top-(n.y-r.top)%m.height)-m.top,t}return t.translateX=n.distanceX,t.translateY=n.distanceY,t},start:function(e,t){c=!0,p(!0),s.turnOff("leftSwipe")},move:function(e,t){},cancel:function(e,t){p(!1),c=!1},end:function(t,n){for(var o=!1,r=0;r<l.length;r++)if(l[r]){var s=l[r].getBoundingClientRect();if(t.x>s.left&&t.x<s.right&&t.y>s.top&&t.y<s.bottom){var u=Math.floor((t.x-s.left)/m.width)+1,d=Math.floor((t.y-s.top)/m.height)+1;1===r?(u=0,d=0):2===r&&(u=(u-1)*-1,d=-1),i.onMove({player:i.player,x:u,y:d})&&t.reset(),o=!0}}o||(null!==i.player.row&&null!==i.player.col?i.onRemove({player:i.player})&&t.reset():t.reset()),a(function(){p(!1),c=!1,e.$apply()},100)}};o.bind(u,d,{}),r.bind(u,{start:function(e){c||(m=u.getBoundingClientRect(),p(!0))},cancel:function(e){c||p(!1)},end:function(e){c||p(!1)}},{})}]});