var osApp=angular.module("OnlineSoccer",["ngRoute","ngSanitize","ngCookies","mobile-angular-ui","mobile-angular-ui.gestures"]);osApp.value("UserData",{loggedIn:!1,teamName:"Demoteam",teamImage:"00000000.png"}),osApp.config(["$routeProvider","$locationProvider",function(t,e){t.when("/",{template:"<login-form></login-form>"}).when("/index.html",{template:"<login-form></login-form>"}).when("/index.php",{template:"<login-form></login-form>"}).when("/zugabgabe.php",{template:"<move-component></move-component>"}).when("/:site",{template:function(t){return'<embedded-site site="../'+t.site+'"></embedded-site>'}}).otherwise({template:'<div class="scrollable"><div class="scrollable-content"><div class="section">Fehler!</div></div></div>'})}]),osApp.controller("MainController",["$scope","UserData",function(t,e){t.userData=e}]),osApp.filter("trustAsResourceUrl",["$sce",function(t){return function(e){return t.trustAsResourceUrl(e)}}]);var osApp=osApp||angular.module("OnlineSoccer");osApp.component("embeddedSite",{templateUrl:"templates/embedded.html",controller:["$sce",function(t){t.trustAsResourceUrl(this.site)}],bindings:{site:"@"}});var osApp=osApp||angular.module("OnlineSoccer");osApp.component("loginForm",{templateUrl:"templates/login.html",controller:["$http","$location","UserData",function(t,e,n){var o=this;this.email=null,this.password=null,this.inProgress=!1,this.failureMsg=null,this.login=function(){this.inProgress=!0,t({url:"../validate.php",method:"POST",transformRequest:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+(null===t[n]?"":encodeURIComponent(t[n])));return e.join("&")},data:{action:"os_login",sdauer:0,loginemail:o.email,passwort:o.password},headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){var r=(new DOMParser).parseFromString(t.data,"text/html"),i=r.getElementsByTagName("p");i&&i.length&&i.length>0?o.failureMsg=i[i.length-1].textContent:(n.loggedIn=!0,n.teamImage="00000019.png",e.path("/haupt.php")),o.inProgress=!1},function(t){})}}]});var osApp=osApp||angular.module("OnlineSoccer"),MenuItem=function(t,e,n){this.id=t.replace(/\W/g,""),this.label=t,this.path=e,this.external=n||!1,this.items=[],this.addMenuItem=function(t){this.items.push(t)}};osApp.component("mainMenu",{templateUrl:"templates/menu.html",controller:["$http","UserData","SharedState",function(t,e,n){var o=this;this.menuItems=[],this.user=e,t({url:"../os_menu_haupt.html",method:"GET",transformResponse:function(t){for(var e,n=/m\((\d+)(?:,"([^"]+)")?(?:,"([^"]+)")?(?:,"([^"]+)")?.*\)/gm,o=[],r=n.exec(t);r;){var i=r[2].replace(/\s*\/\s*/," / "),s=(!r[4]||"os_main"!==r[4])&&"index.php"!==r[3],a=r[3]?s?r[3]:"#/"+r[3]:void 0;1===+r[1]?(e=new MenuItem(i,a,s),o.push(e)):e.addMenuItem(new MenuItem(i,a,s)),r=n.exec(t)}return o}}).then(function(t){o.menuItems=t.data},function(t){}),this.handleItemClick=function(t){t.items.length>0?(n.get("submenu")===t.id&&n.isActive(t.id)?n.turnOff(t.id):n.turnOn(t.id),n.set("submenu",t.id)):n.turnOff("uiSidebarLeft")},this.getIconClass=function(t){return t.items.length>0?n.get("submenu")===t.id&&n.isActive(t.id)?"fa-chevron-circle-down":"fa-chevron-circle-right":"fa-caret-square-o-right"}}]});var osApp=osApp||angular.module("OnlineSoccer");osApp.factory("Player",[function(){function t(){this.id=0,this.name="",this.pos="",this.alter=0,this.moral=0,this.fitness=0,this.skill=0,this.opti=0,this.sonder=""}return t.Positions=["TOR","ABW","DMI","MIT","OMI","STU"],t.prototype={isSet:function(){return null!=this.row&&null!=this.col},getShortName:function(){var t=this.name.split(" ");return t[t.length-1]}},t}]),osApp.factory("HtmlTransformationUtil",[function(){return{extractIdFromHref:function(t){if(t){if(t.search(/javascript:.+(\d+)/)!==-1)return+t.split("(")[1].split(")")[0];if(t.search(/sp\.php.+s=(\d+)/)!==-1)return+t.split("s=")[1].split("&")[0];if(t.search(/st\.php.+c=(\d+)/)!==-1)return+t.split("c=")[1].split("&")[0]}return null}}}]),osApp.factory("Move",["Player",function(t){function e(){this.players=[],this.information={},this.information.zat=0,this.information.date=new Date,this.information.type="",this.information.home=!1,this.information.against={},this.information.against.id=0,this.information.against.name="",this.options=[],this.Option=function(){this.page=0,this.item=0,this.text=""},this.adjustments=[],this.Adjustment=function(){this.option=new Option,this.id=0,this.text=""}}return e.GRID_ROWS=15,e.GRID_COLUMNS=11,e.prototype={sortPlayers:function(){return this.players.length>0&&this.players.sort(function(e,n){var o=t.Positions.indexOf(n.pos)-t.Positions.indexOf(e.pos);return 0===o?n.opti-e.opti:o}),this.players}},e}]),osApp.factory("MoveTransformation",["Move","Player","HtmlTransformationUtil",function(t,e,n){var o={transformSetup:function(o){var r=new t,i=(new DOMParser).parseFromString(o,"text/html"),s=i.getElementsByTagName("table"),a=s[1].rows[0].cells[0],l=s[1].rows[0].cells[1],p=s[3],u=s[4],m=/ZA f.+r ZAT (\d+) Termin: \w+, (\w+ )*(\d+)\.[ ]*([\d|\w]+)[\.| ]*(\d\d\d\d)[\.| ]*(\d+):(\d+):*(\d+)*/gm,c=m.exec(a.textContent);if(c){r.information.zat=+c[1];var f=c[3],h=+c[4]-1||["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"].indexOf(c[4]),d=c[5],g=c[6],v=c[7],y=c[8]||0;r.information.date=new Date(d,h,f,g,v,y)}m=/(\w+) ([\w|ä]+) : <a href="javascript:teaminfo\((\d+)\)">(.*)<\/a>/gm,c=m.exec(l.innerHTML),c&&(r.information.type=c[1],r.information.home="Heim"===c[2],r.information.against={},r.information.against.id=+c[3],r.information.against.name=c[4]);var w,x,S,b=[];for(x=1;x<=t.GRID_ROWS;x++)for(w=p.rows[x],S=1;S<=t.GRID_COLUMNS;S++)b.push(w.cells[S].textContent);for(x=1;x<u.rows.length;x++)if(w=u.rows[x],9===w.cells.length){var A=new e;A.id=n.extractIdFromHref(w.cells[1].firstChild.href),A.name=w.cells[1].textContent,A.pos=w.cells[1].className,A.alter=+w.cells[2].textContent,A.moral=+w.cells[4].textContent,A.fitness=+w.cells[5].textContent,A.skill=+w.cells[6].textContent,A.opti=+w.cells[7].textContent,A.sonder=w.cells[8].textContent;var O=w.cells[0].firstChild.value;if("T"===O)A.col=0,A.row=0;else{var M=["V","W","X","Y","Z","U"].indexOf(O);if(M>=0)A.col=-M,A.row=-1;else{var C=b.indexOf(O);O&&C>=0&&(A.col=C%11+1,A.row=Math.floor(C/11)+1)}}r.players.push(A)}return r},transformActions:function(t){return o._transformOptions(t,1)},transformOptions:function(t){return o._transformOptions(t,2)},_transformOptions:function(e,n){for(var o,r=new t,i=(new DOMParser).parseFromString(e,"text/html"),s={},a=i.getElementsByTagName("select")[0],l=0;l<a.options.length;l++){var p=new r.Option;p.page=n,p.item=+a.options[l].value,p.text=a.options[l].text,p.item>0&&(r.options.push(p),o=p.text.split(" festlegen")[0].replace("schütze","").replace("Taktik","Grundtaktik"),s[o]=p)}for(var u=i.getElementsByTagName("table")[3],m=0;m<u.rows.length-1;m++){var c=u.rows[m],f=new r.Adjustment;f.id=+c.cells[0].firstChild.value,f.text=c.cells[1].textContent;for(o in s)s.hasOwnProperty(o)&&f.text.search(o)!==-1&&(f.option=s[o]);r.adjustments.push(f)}return r}};return o}]),osApp.factory("MoveWebClient",["$q","$http","Move","MoveTransformation",function(t,e,n,o){return{loadMove:function(n){var r=t.defer(),i=[];return i.push(e({url:"../zugabgabe.php",method:"GET",transformResponse:o.transformSetup})),i.push(e({url:"../zugabgabe.php?p=1",method:"GET",transformResponse:o.transformActions})),i.push(e({url:"../zugabgabe.php?p=2",method:"GET",transformResponse:o.transformOptions})),t.all(i).then(function(t){var e=t[0].data;e.options=t[1].data.options.concat(t[2].data.options),e.adjustments=t[1].data.adjustments.concat(t[2].data.adjustments),r.resolve(e)},r.reject,r.notify),r.promise},saveMove:function(t){return e({url:"../zugabgabe-beta.php",method:"POST"})}}}]),osApp.component("moveComponent",{templateUrl:"templates/move.html",controller:["$location","SharedState","MoveWebClient","Move",function(t,e,n,o){var r=this;r.players=[],r.options=[],r.adjustments=[];var i=6;r.grid=function(){for(var t=new Array(o.GRID_ROWS),e=0;e<o.GRID_ROWS;e++)t[e]=new Array(o.GRID_COLUMNS);return t}(),r.grid.setPlayer=function(t,e,n){var o=null;return n>0?(o=r.grid[n-1][e-1],r.grid[n-1][e-1]=t):o=0===e&&0===n?r.getKeeper():r.getSubst()[-e],t.isSet()&&t.row>0&&(r.grid[t.row-1][t.col-1]=o),o&&(o.row=t.row,o.col=t.col),t.row=n,t.col=e,o},r.grid.removePlayer=function(t){t.isSet()&&t.row>0&&(r.grid[t.row-1][t.col-1]=null),t.row=null,t.col=null},r.getKeeper=function(){for(var t=0;t<r.players.length;t++){var e=r.players[t];if(0===e.row&&0===e.col)return e}return null},r.getSubst=function(){for(var t=new Array(i),e=0;e<r.players.length;e++){var n=r.players[e];n.row===-1&&(t[-n.col]=n)}return t},r.save=function(){console.log("SAVE: "+JSON.stringify(r.players))},n.loadMove().then(function(t){r.information=t.information,r.players=t.sortPlayers(),r.options=t.options,r.adjustments=t.adjustments;for(var e=0;e<r.players.length;e++){var n=r.players[e];n.row>0&&n.col>0&&(r.grid[n.row-1][n.col-1]=n)}},function(e){console.error(e),t.path("#/error")})}]}),osApp.component("player",{templateUrl:"templates/gridplayer.html",bindings:{player:"<object",onMove:"&",onRemove:"&"},controller:["$scope","$element","$document","$drag","$timeout","SharedState",function(t,e,n,o,r,i){var s=this,a=[];a.push(document.querySelector(".grid-container")),a.push(document.querySelector(".keeper-container")),a.push(document.querySelector(".subst-container"));var l=e[0].firstChild,p=l.getBoundingClientRect(),u=function(){if(!s.player.isSet()){var t=document.querySelector(".selection-container");if(t)return function(){angular.element(t).toggleClass("moving"),angular.element(l).toggleClass("moving")}}return function(){angular.element(l).toggleClass("moving"),angular.element(l.nextElementSibling).toggleClass("moving")}}(),m={transform:function(t,e,n){for(var o=0;o<a.length;o++)if(a[o]){var r=a[o].getBoundingClientRect();if(n.x>r.left&&n.x<r.right&&n.y>r.top&&n.y<r.bottom)return e.translateX=r.left+(n.x-r.left-(n.x-r.left)%p.width)-p.left,e.translateY=r.top+(n.y-r.top-(n.y-r.top)%p.height)-p.top,e}return e.translateX=n.distanceX,e.translateY=n.distanceY,e},start:function(t,e){p=t.startRect,u(),i.turnOff("leftSwipe")},move:function(t,e){},cancel:function(t,e){u()},end:function(e,n){for(var o=!1,i=0;i<a.length;i++)if(a[i]){var l=a[i].getBoundingClientRect();if(e.x>l.left&&e.x<l.right&&e.y>l.top&&e.y<l.bottom){var m=Math.floor((e.x-l.left)/p.width)+1,c=Math.floor((e.y-l.top)/p.height)+1;1===i?(m=0,c=0):2===i&&(m=(m-1)*-1,c=-1),s.onMove({player:s.player,x:m,y:c})&&e.reset(),o=!0}}o||(s.player.isSet()?s.onRemove({player:s.player}):e.reset()),r(function(){u(),t.$apply()},100)}};o.bind(l,m,{})}]});