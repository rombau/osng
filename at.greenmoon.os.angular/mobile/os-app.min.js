var osApp=angular.module("OnlineSoccer",["ngRoute","ngSanitize","ngCookies","mobile-angular-ui","mobile-angular-ui.gestures"]);osApp.config(["$provide","$routeProvider","$locationProvider","$httpProvider",function(e,t,n,o){t.when("/",{template:"<login-component></login-component>"}).when("/index.html",{template:"<login-component></login-component>"}).when("/index.php",{template:"<login-component></login-component>"}).when("/haupt.php",{template:"<office-component></office-component>"}).when("/error",{template:'<div class="scrollable"><div class="scrollable-content"><div class="section"><span ng-bind-html="error"></span></div></div></div>'}).when("/zugabgabe.php",{template:"<move-component></move-component>"}).when("/player/:id",{template:function(e){return'<embedded-site site="../sp.php?s='+e.id+'"></embedded-site>'}}).when("/:site",{template:function(e){return'<embedded-site site="../'+e.site+'"></embedded-site>'}}).otherwise({template:'<div class="scrollable"><div class="scrollable-content"><div class="section">Unbekannte Seite!</div></div></div>'}),e.factory("ErrorInterceptor",["$rootScope","$location",function(e,t){return{responseError:function(n){e.error=""+n,t.path("error")}}}]),e.factory("LoadingInterceptor",[function(){var e=document.querySelector(".app-progress-indicator"),t=0;return{request:function(n){0===t&&angular.element(e).addClass("loading");var o=document.querySelector(".modal");return o&&angular.element(o).addClass("loading"),t++,n},requestError:function(e){return e},response:function(n){t--,0===t&&angular.element(e).removeClass("loading");var o=document.querySelector(".modal");return o&&angular.element(o).removeClass("loading"),n},responseError:function(n){t--,angular.element(e).removeClass("loading");var o=document.querySelector(".modal");return o&&angular.element(o).removeClass("loading"),n}}}]),o.interceptors.push("LoadingInterceptor"),o.interceptors.push("ErrorInterceptor")}]),osApp.filter("trustAsResourceUrl",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]),osApp.run(["$rootScope","Popup",function(e,t){e.$on("$locationChangeStart",function(n,o,r){!e.error&&t.hide()&&n.preventDefault()}),e.$on("mobile-angular-ui.state.changed.leftSwipe",function(e,n,o){n&&t.sidebar("leftSwipe")})}]),osApp.factory("Player",[function(){function e(e){this.id=0,this.name=e||"",this.pos="",this.alter=0,this.geburtstag=0,this.land="",this.flagge="",this.moral=0,this.fitness=0,this.skills=[],this.skill=0,this.opti=0,this.sonder="",this.gehalt=0,this.marktwert=0,this.vertrag=0,this.team=null}return e.Position={LEI:"LEI",TOR:"TOR",ABW:"ABW",DMI:"DMI",MIT:"MIT",OMI:"OMI",STU:"STU"},e.Skill={SCH:0,BAK:1,KOB:2,ZWK:3,DEC:4,GES:5,FUQ:6,ERF:7,AGG:8,PAS:9,AUS:10,UEB:11,WID:12,SEL:13,DIS:14,ZUV:15,EIN:16},e.prototype={getShortName:function(){for(var e=[" "," Van "," van "," De "," de "],t=this.name,n=this.name.length,o=0;o<e.length;o++){var r=this.name.lastIndexOf(e[o]);r>-1&&r<n&&(n=r)}return n!==this.name.length&&(t=this.name.substr(n+1)),t.replace(" ","&nbsp;")},isPrimarySkill:function(t){switch(this.pos){case e.Position.TOR:if(t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.DEC||t===e.Skill.GES)return!0;break;case e.Position.ABW:if(t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.DEC||t===e.Skill.ZUV)return!0;break;case e.Position.DMI:if(t===e.Skill.BAK||t===e.Skill.DEC||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.MIT:if(t===e.Skill.BAK||t===e.Skill.ZWK||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.OMI:if(t===e.Skill.BAK||t===e.Skill.GES||t===e.Skill.PAS||t===e.Skill.UEB)return!0;break;case e.Position.STU:if(t===e.Skill.SCH||t===e.Skill.KOB||t===e.Skill.ZWK||t===e.Skill.GES)return!0}return!1},getSkillCaption:function(t){switch(t){case e.Skill.SCH:return this.pos===e.Position.TOR?"Abstoss":"Schuss";case e.Skill.BAK:return this.pos===e.Position.TOR?"Stellungsspiel":"Ballkontrolle";case e.Skill.KOB:return this.pos===e.Position.TOR?"Fangsicherheit":"Kopfball";case e.Skill.ZWK:return this.pos===e.Position.TOR?"Strafraumbeh.":"Zweikampf";case e.Skill.DEC:return this.pos===e.Position.TOR?"Spiel auf der Linie":"Deckung";case e.Skill.GES:return this.pos===e.Position.TOR?"Reflexe":"Geschwindigkeit";case e.Skill.FUQ:return"Führungsfertigkeit";case e.Skill.ERF:return"Erfahrung";case e.Skill.AGG:return"Aggressivität";case e.Skill.PAS:return"Passgenauigkeit";case e.Skill.AUS:return"Ausdauer";case e.Skill.UEB:return"Übersicht";case e.Skill.WID:return"Widerstandskraft";case e.Skill.SEL:return"Selbstbewusstsein";case e.Skill.DIS:return"Disziplin";case e.Skill.ZUV:return"Zuverlässigkeit";case e.Skill.EIN:return"Einstellung"}}},e}]),osApp.factory("Team",[function(){function e(){this.id=0,this.name="Demoteam",this.image="00000000.png",this.liga=0,this.liganame="",this.land="",this.player=[],this.otherId=null}return e.prototype={getFullName:function(){return this.name+" ("+this.liganame+" "+this.land+")"}},e}]),osApp.factory("Move",["Player",function(e){function t(){this.valid=!1,this.players=[],this.information={},this.information.zat=0,this.information.date=new Date,this.information.type="",this.information.home=!1,this.information.against={},this.information.against.id=0,this.information.against.name="",this.zats=[],this.options=[],this.Option=function(){this.page=0,this.item=0,this.text=""},this.adjustments=[],this.Adjustment=function(){this.option=new Option,this.id=0,this.text="",this.params={zao_einspieler:{},zao_spieler:{},zao_minute:{},zao_abhaengigkeit:{},P1:{},P2:{},P3:{},spieler_id:{}}}}return t.GRID_ROWS=15,t.GRID_COLUMNS=11,t.SET_PLAYER_INDICATOR=" ◉",t.SUBSTITUTE_INDICATOR=" ⇄",t.prototype={sortPlayers:function(){return this.players.length>0&&this.players.sort(function(t,n){var o=[e.Position.TOR,e.Position.ABW,e.Position.DMI,e.Position.MIT,e.Position.OMI,e.Position.STU],r=o.indexOf(n.pos)-o.indexOf(t.pos);return 0===r?n.opti-t.opti:r}),this.players},getStartPlayersAverage:function(e){for(var t=0,n=0,o=0;o<this.players.length;o++){var r=this.players[o];null!==r.row&&null!==r.col&&void 0!==r.row&&void 0!==r.col&&r.row>=0&&r[e]&&(t+=r[e],n++)}var a=Math.round(t/n*100)/100;return isNaN(a)?0:a},generateAdjustmentText:function(e){var t,n,o="",r=e.params.zao_abhaengigkeit.text;switch(r&&(n="in der "+e.params.zao_minute.text+". Minute","Immer durchführen"===r?r="Immer":-1!==(t=r.search(/ in/))?r=r.substring(0,t):-1!==(t=r.search(/ ab/))&&(r=r.substring(0,t),n="ab der "+e.params.zao_minute.text+". Minute")),e.option.item){case 1:o+=r,o+=" : ",o+=e.option.text,o+=" von ",o+=e.params.zao_einspieler.text,o+=" für ",o+=e.params.zao_spieler.text,o+=" ",o+=n,o+=" ",o+=e.params.P3.text||"auf Position "+e.params.P1.text+e.params.P2.text;break;case 5:o+=r,o+=" : ",o+=e.option.text,o+=" von ",o+=e.params.zao_spieler.text,o+=" auf Position ",o+=e.params.P1.text+e.params.P2.text,o+=" ",o+=n;break;case 6:o+=r,o+=" : ",o+="Positionsbezogen"===e.params.P1.text?"Positionsbezogene Manndeckung":"Manndeckung aufheben"===e.params.P1.text?"Manndeckung aufheben":"Manndeckung von "+e.params.P1.text,o+=" durch ",o+=e.params.zao_spieler.text,o+=" ",o+=n;break;case 2:case 3:case 4:o+=r,o+=" : ",o+=e.option.text,o+=" einstellen auf ",o+=e.params.P1.text,o+=" ",o+=n;break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:o=e.option.text+" : "+e.params.spieler_id.text;break;case 16:case 17:case 18:o+=r,o+=" : ",o+=n,o+=" ",o+=e.option.text.replace("Taktik","- Grundtaktik"),o+=" : ",o+=e.params.P1.text}return o}},t}]),osApp.factory("Account",["$http","$q","Team","HtmlUtil",function(e,t,n,o){var r=[],a={transformMain:function(e){var t,r,a=o.getEnsuredDocument(e),l=a.getElementsByTagName("img"),i=a.getElementsByTagName("b"),s=a.getElementsByTagName("a"),u=l[l.length-1],c=[new n];t=/images\/wappen\/((\d+)\.(png|gif))/gm,r=t.exec(u.src||u.outerHTML),r&&(c[0].id=+r[2],c[0].image=r[1]);for(var m=0;m<i.length;m++)i[m].textContent.search(/Willkommen im Managerb/)!==-1&&(c[0].name=i[m].textContent.split(" von ")[1]);for(var p=0;p<s.length;p++)if(t=/Zu ((\w+\s*)+) wechseln/gm,r=t.exec(s[p].textContent)){c.push(new n),c[1].name=r[1];break}return c},transformFirstTeam:function(e){for(var t=o.getEnsuredDocument(e),n=t.getElementsByTagName("a"),r=0;r<n.length;r++)if(n[r].textContent.search(/Mein (Zweit|Haupt)team/)!==-1)return o.extractIdFromHref(n[r].href);return null},transformSecondTeam:function(e){var t,n,r=o.getEnsuredDocument(e),a=r.getElementsByTagName("img"),l=a[0];return t=/images\/wappen\/((\d+)\.(png|gif))/gm,n=t.exec(l.src||l.outerHTML),n?n[1]:null},transformLoginValidation:function(e){var t=o.getEnsuredDocument(e),n=t.getElementsByTagName("p");if(n&&n.length&&n.length>0)throw n[n.length-1].textContent;return!0}},l=function(n){return t(function(t,o){e({url:"../haupt.php"+(n?"?changetosecond=true":""),method:"GET",transformResponse:a.transformMain}).then(function(l){n?t(r):(r=l.data,1===r.length?t(r):e({url:"../st.php?c="+r[0].id,method:"GET",transformResponse:a.transformFirstTeam}).then(function(n){if(n.data){var l=n.data;r[1].id=l,e({url:"../st.php?c="+r[1].id,method:"GET",transformResponse:a.transformSecondTeam}).then(function(e){e.data&&(r[1].image=e.data),t(r)},function(){o()})}},function(){o()}))},function(){o()})})},i=!1;return{clearTeams:function(){r=[]},getTeams:function(){return 0!==r.length||i||(i=!0,l().then(function(){i=!1})),r},toggleTeam:function(){return t(function(e,t){l(!0).then(function(){r.reverse(),e()},function(){t()})})},login:function(n,r){return t(function(t,l){e({url:"../validate.php",method:"POST",data:{action:"os_login",sdauer:0,loginemail:n,passwort:r},headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:o.encodeQueryParameters,transformResponse:a.transformLoginValidation}).then(function(e){t(e)},function(){l()})})}}}]),osApp.factory("Popup",["SharedState",function(e){var t=null;return{open:function(n,o){n&&(o?e.setOne(n,o):e.turnOn(n),t=n)},hide:function(){return!!t&&(e.turnOff(t),t=null,!0)},sidebar:function(e){e&&(t=e)}}}]),osApp.factory("HtmlUtil",["$injector",function(e){return{extractIdFromHref:function(e){if(e){if(e.search(/javascript:.+(\d+)/)!==-1)return+e.split("(")[1].split(")")[0];if(e.search(/sp\.php.+s=(\d+)/)!==-1)return+e.split("s=")[1].split("&")[0];if(e.search(/st\.php.+c=(\d+)/)!==-1)return+e.split("c=")[1].split("&")[0]}return null},getEnsuredDocument:function(t){if(!t)throw"Seite konnte nicht geladen werden.";var n,o;if(n=/F.+r die Dauer von ZAT (\d+) sind die Seiten von OS 2\.0 gesperrt!/gm,o=n.exec(t))throw o[0];if(n=/Diese Seite ist ohne Team nicht verf.+gbar!/gm,o=n.exec(t)){var r=e.get("Account");throw r&&r.clearTeams(),o[0]}return(new DOMParser).parseFromString(t,"text/html")},encodeQueryParameters:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+(null===e[n]?"":encodeURIComponent(e[n])));return t.join("&")}}}]),osApp.component("loginComponent",{templateUrl:"components/login/login.html",controller:["$location","Account",function(e,t){var n=this;n.loggedIn=!1,n.login=function(){t.login(n.email,n.password).then(function(o){o.data&&(n.loggedIn=!0,t.clearTeams(),e.path("/haupt.php"))})}}]});var MenuItem=function(e,t,n){this.id=e.replace(/\W/g,""),this.label=e,this.path=t,this.external=n||!1,this.items=[],this.addMenuItem=function(e){this.items.push(e)}};osApp.component("mainMenu",{templateUrl:"components/menu/menu.html",controller:["$http","$route","Account","SharedState",function(e,t,n,o){var r=this;r.menuItems=[],r.account=n,e({url:"../os_menu_haupt.html",method:"GET",transformResponse:function(e){for(var t,n=/m\((\d+)(?:,"([^"]+)")?(?:,"([^"]+)")?(?:,"([^"]+)")?.*\)/gm,o=[],r=n.exec(e);r;){var a=r[2].replace(/\s*\/\s*/," / "),l=(!r[4]||"os_main"!==r[4])&&"index.php"!==r[3],i=r[3]?l?r[3]:"#/"+r[3]:void 0;1===+r[1]?(t=new MenuItem(a,i,l),o.push(t)):t.addMenuItem(new MenuItem(a,i,l)),r=n.exec(e)}return o}}).then(function(e){r.menuItems=e.data}),r.handleItemClick=function(e){e.items.length>0?(o.get("submenu")===e.id&&o.isActive(e.id)?o.turnOff(e.id):o.turnOn(e.id),o.set("submenu",e.id)):o.turnOff("uiSidebarLeft")},r.getIconClass=function(e){return e.items.length>0?o.get("submenu")===e.id&&o.isActive(e.id)?"fa-chevron-circle-down":"fa-chevron-circle-right":"fa-caret-square-o-right"},r.changeToOtherTeam=function(){n.toggleTeam().then(function(){t.reload()})}}]}),osApp.component("embeddedSite",{templateUrl:"components/embedded/embedded.html",bindings:{site:"@",onLoad:"&"},controller:["$sce","Account",function(e,t){var n=this,o=document.querySelector(".app-progress-indicator");angular.element(o).addClass("loading"),window.embeddedLoaded=function(){angular.element(o).removeClass("loading");var e=this.document,r=e.body.textContent;r.indexOf("Demoteam")===-1&&r.indexOf("ohne Team")===-1||t.clearTeams(),n.onLoad()},e.trustAsResourceUrl(this.site)}]}),osApp.component("officeComponent",{templateUrl:"components/office/office.html",controller:["$document","$location",function(e,t){var n=this;n.onLoad=function(){for(var n=e[0].querySelector("#embeddedOffice #embedFrame").contentDocument,o=n.getElementsByTagName("a"),r=0;r<o.length;r++)o[r].href.indexOf("zugabgabe.php")!==-1&&(o[r].href=t.absUrl().split("#")[0]+"#/zugabgabe.php",o[r].target="_top",o[r].id="move")}}]}),osApp.factory("PlayerTransformation",["Player","Team","HtmlUtil",function(e,t,n){var o={transformPlayer:function(o){var r=new e,a=n.getEnsuredDocument(o),l=a.querySelector("img[alt=Face]");r.id=+l.src.split("faceprev.php?sid=")[1];var i=a.getElementsByTagName("table");r.name=i[0].rows[0].cells[2].textContent,r.alter=+i[0].rows[0].cells[5].textContent,r.gehalt=+i[0].rows[0].cells[8].textContent.match(/([\d|\.]+) EUR/)[1].replace(/\./g,""),r.land=i[0].rows[1].cells[1].textContent.trim(),r.flagge="/"+i[0].rows[1].cells[1].firstChild.getAttribute("src"),r.geburtstag=+i[0].rows[1].cells[4].textContent.substring(4),r.vertrag=+i[0].rows[1].cells[7].textContent,r.marktwert=+i[0].rows[2].cells[1].textContent.match(/([\d|\.]+) EUR/)[1].replace(/\./g,""),r.pos=i[0].rows[2].cells[4].textContent,r.team=new t;var s=i[0].rows[2].cells[7].childNodes;return r.team.id=n.extractIdFromHref(s[0].href),r.team.name=s[0].textContent,r.team.liga=+s[2].textContent.split(". Liga")[0],r.team.liganame=s[2].textContent.trim(),r.team.land=s[3].textContent,r.skill=+i[1].rows[0].cells[0].textContent.split(" : ")[1],r.opti=+i[1].rows[0].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.SCH]=+i[1].rows[1].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.BAK]=+i[1].rows[1].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.KOB]=+i[1].rows[1].cells[4].textContent.split(" : ")[1],r.skills[e.Skill.ZWK]=+i[1].rows[2].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.DEC]=+i[1].rows[2].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.GES]=+i[1].rows[2].cells[4].textContent.split(" : ")[1],r.skills[e.Skill.FUQ]=+i[1].rows[3].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.ERF]=+i[1].rows[3].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.AGG]=+i[1].rows[3].cells[4].textContent.split(" : ")[1],r.skills[e.Skill.PAS]=+i[1].rows[4].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.AUS]=+i[1].rows[4].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.UEB]=+i[1].rows[4].cells[4].textContent.split(" : ")[1],r.skills[e.Skill.WID]=+i[1].rows[5].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.SEL]=+i[1].rows[5].cells[2].textContent.split(" : ")[1],r.skills[e.Skill.DIS]=+i[1].rows[5].cells[4].textContent.split(" : ")[1],r.skills[e.Skill.ZUV]=+i[1].rows[6].cells[0].textContent.split(" : ")[1],r.skills[e.Skill.EIN]=+i[1].rows[6].cells[2].textContent.split(" : ")[1],r}};return o}]),osApp.factory("PlayerWebClient",["$http","Player","PlayerTransformation",function(e,t,n){return{loadPlayer:function(t){return e({url:"../sp.php?s="+t,method:"GET",transformResponse:n.transformPlayer})}}}]),osApp.component("player",{templateUrl:"components/player/player.html",bindings:{player:"<object"},controller:["PlayerWebClient",function(e){var t=this;e.loadPlayer(t.player.id).then(function(e){t.player=e.data})}]}),osApp.component("playerLink",{templateUrl:"components/player/player.link.html",bindings:{player:"<object"},controller:["Popup",function(e){var t=this;t.openPopup=function(){e.open("modalPlayer",t.player)}}]}),osApp.factory("MoveTransformation",["Move","Player","HtmlUtil",function(e,t,n){var o={transformSetup:function(o){var r=new e,a=n.getEnsuredDocument(o),l=a.getElementsByTagName("table"),i=l[1].rows[0].cells[0],s=l[1].rows[0].cells[1],u=l[1].rows[0].cells[2],c=l[3],m=l[4],p=/ZA f.+r ZAT (\d+) Termin: \w+,* ([A-z]+ )*(\d+)\.[ ]*([\w|ä]+)[\.| ]*(\d\d\d\d)* ([A-z]+ )*(\d+)[\.|:](\d+)[\.|:]*(\d+)*/gm,f=p.exec(i.textContent);if(f){r.information.zat=+f[1];var d=f[3],h=+f[4]-1||["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"].indexOf(f[4]),g=f[5]||(new Date).getFullYear(),v=f[7],S=f[8],w=f[9]||0;r.information.date=new Date(g,h,d,v,S,w)}p=/(\w+) ([\w|ä]+) : <a href="javascript:teaminfo\((\d+)\)">(.*)<\/a>/gm,f=p.exec(s.innerHTML),f&&(r.information.type=f[1],r.information.home="Heim"===f[2],r.information.against={},r.information.against.id=+f[3],r.information.against.name=f[4]),r.valid=/Zugabgabe: G.+ltig/.test(u.textContent);var y,b,k,T=[];for(b=1;b<=e.GRID_ROWS;b++)for(y=c.rows[b],k=1;k<=e.GRID_COLUMNS;k++)T.push(y.cells[k].textContent);for(b=1;b<m.rows.length;b++)if(y=m.rows[b],9===y.cells.length){var x=new t;x.id=n.extractIdFromHref(y.cells[1].firstChild.href),x.name=y.cells[1].textContent,x.pos=y.cells[1].className,x.alter=+y.cells[2].textContent,x.moral=+y.cells[4].textContent,x.fitness=+y.cells[5].textContent,x.skill=+y.cells[6].textContent,x.opti=+y.cells[7].textContent,x.sonder=y.cells[8].textContent,x.col=null,x.row=null;var C=y.cells[0].firstChild.value;if("T"===C)x.col=0,x.row=0;else{var A=["V","W","X","Y","Z","U"].indexOf(C);if(A>=0)x.col=-A,x.row=-1;else{var E=T.indexOf(C);C&&E>=0&&(x.col=E%11+1,x.row=Math.floor(E/11)+1)}}r.players.push(x)}for(var P=a.getElementsByName("lauf")[0],I=0;I<P.options.length;I++){var O={};O.value=+P.options[I].value,O.label=P.options[I].text,O.value>0&&r.zats.push(O)}return r},transformActions:function(e){return o._transformOptions(e,1)},transformOptions:function(e){return o._transformOptions(e,2)},_transformOptions:function(t,o){for(var r,a=new e,l=n.getEnsuredDocument(t),i={},s=l.getElementsByTagName("select")[0],u=0;u<s.options.length;u++){var c=new a.Option;c.page=o,c.item=+s.options[u].value,c.text=s.options[u].text,c.item>0&&(a.options.push(c),r=c.text.split(" festlegen")[0].replace("schütze","").replace("Taktik","Grundtaktik"),i[r]=c)}for(var m=l.getElementsByTagName("table")[3],p=0;p<m.rows.length-1;p++){var f=m.rows[p],d=new a.Adjustment;d.id=+f.cells[0].firstChild.value,d.text=f.cells[1].textContent.replace(/ *: /g," : ");for(r in i)i.hasOwnProperty(r)&&d.text.search(r)!==-1&&(d.option=i[r]);a.adjustments.push(d)}return a},transformAdjustmentForm:function(t){for(var o={method:"GET",lines:[]},r=n.getEnsuredDocument(t),a=r.getElementsByTagName("table")[3],l=0;l<a.rows.length-1;l++){for(var i=a.rows[l],s=i.cells[0].getElementsByTagName("select").length>0,u={label:s?"":i.cells[0].textContent,combos:[]},c=i.cells[s?0:1].getElementsByTagName("select"),m=12,p=0;p<c.length;p++){for(var f=c[p],d={name:f.name,options:[]},h=0,g=0;g<f.options.length;g++){var v=f.options[g];h=Math.max(h,v.textContent.length),d.options.push({label:v.textContent.replace(/ \([A-T]\)/,e.SET_PLAYER_INDICATOR).replace(/ \([U-Z]\)/,e.SUBSTITUTE_INDICATOR),value:v.value})}d.width=h>2?h>5?m:3:2,d.value=f.value||d.options[0].value,u.combos.push(d),m-=d.width}o.lines.push(u)}return o},transformPlayers:function(e){var t,n=[],o=[];for(t=0;t<e.length;t++){var r=e[t];null!==r.row&&null!==r.col&&void 0!==r.row&&void 0!==r.col&&(n.push(["player_"+r.id,r.col,r.row]),r.row===-1&&(o[-r.col]=r))}if(n.length<17)for(t=0;t<6;t++)o[t]||n.push(["player_0",-t,-1]);return"aufstellung="+JSON.stringify(n)}};return o}]),osApp.factory("MoveWebClient",["$q","$http","Move","MoveTransformation",function(e,t,n,o){return{loadMove:function(n){var r;return t({url:"../zugabgabe.php"+(n?"?lauf="+n:""),method:"GET",transformResponse:o.transformSetup}).then(function(n){r=n.data;var a=e.defer(),l=[];return l.push(t({url:"../zugabgabe.php?p=1",method:"GET",transformResponse:o.transformActions})),l.push(t({url:"../zugabgabe.php?p=2",method:"GET",transformResponse:o.transformOptions})),e.all(l).then(function(e){r.options=e[0].data.options.concat(e[1].data.options),r.adjustments=e[0].data.adjustments.concat(e[1].data.adjustments),a.resolve(r)},a.reject,a.notify),a.promise})},saveMove:function(n){return t({url:"../zugabgabe_beta.php",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:n.players,transformRequest:o.transformPlayers}).then(function(o){var r=e.defer();if("Count mismatch"===o.data)return r.reject(o.data),r.promise;for(var a=[],l=0;l<n.adjustments.length;l++){var i=n.adjustments[l];if(!i.id||i.markDeleted){var s;if(i.markDeleted)s={p:i.option.page,delzae:i.id,delete:"++++Gewählte+Aktion+löschen+++"};else{s={p:i.option.page,itemcreate:i.option.item,anlegen:"+++Neue+Aktion+anlegen+++"};for(var u in i.params)i.params.hasOwnProperty(u)&&(s[u]=i.params[u].value)}a.push(t({url:"../zugabgabe.php",params:s,method:"GET"}))}}return e.all(a).then(function(e){t({url:"../checkza.php",method:"GET"}).then(r.resolve,r.reject,r.notify)},r.reject,r.notify),r.promise})},loadAdjustmentForm:function(e){return t({url:"../zugabgabe.php?p="+e.page+"&item="+e.item,method:"GET",transformResponse:o.transformAdjustmentForm})}}}]),osApp.component("moveComponent",{templateUrl:"components/move/move.html",controller:["$location","$window","SharedState","Popup","MoveWebClient","Move",function(e,t,n,o,r,a){var l=this;l.move=new a,l.adjustmentForm={};var i=6;l.grid=function(){for(var e=new Array(a.GRID_ROWS),t=0;t<a.GRID_ROWS;t++)e[t]=new Array(a.GRID_COLUMNS);return e}(),l.isPlayerSet=function(e){if(e)return null!==e.row&&null!==e.col&&void 0!==e.row&&void 0!==e.col;for(var t=0;t<l.move.players.length;t++)if(l.isPlayerSet(l.move.players[t]))return!0;return!1},l.grid.setPlayer=function(e,t,o){var r=null;return r=o>0?l.grid[o-1][t-1]:0===t&&0===o?l.getKeeper():l.getSubst()[-t],2===n.get("activeTab")?(o>0?e.row===-1?l.addAdjustment(l.move.options[0],function(n){l.adjustmentForm.lines[0].combos[0].value=""+e.id,r?(n.lines[1].combos[0].value=""+r.id,n.lines[4].combos[2].value="K"):(n.lines[4].combos[0].value=String.fromCharCode(65+(a.GRID_ROWS-o)),n.lines[4].combos[1].value=""+t)}):r||l.addAdjustment(l.move.options[4],function(n){n.lines[0].combos[0].value=""+e.id,n.lines[1].combos[0].value=String.fromCharCode(65+(a.GRID_ROWS-o)),n.lines[1].combos[1].value=""+t}):0===t&&0===o?e.row===-1&&l.addAdjustment(l.move.options[0],function(t){t.lines[0].combos[0].value=""+e.id,r&&(t.lines[1].combos[0].value=""+r.id),t.lines[4].combos[2].value="T"}):e.row!==-1&&l.addAdjustment(l.move.options[0],function(t){t.lines[1].combos[0].value=""+e.id,r&&(t.lines[0].combos[0].value=""+r.id),t.lines[4].combos[2].value="K"}),!0):(o>0&&(l.grid[o-1][t-1]=e),l.isPlayerSet(e)&&e.row>0&&(l.grid[e.row-1][e.col-1]=r),r&&(r.row=e.row,r.col=e.col),e.row=o,e.col=t,r)},l.grid.removePlayer=function(e){return 2===n.get("activeTab")||(l.isPlayerSet(e)&&e.row>0&&(l.grid[e.row-1][e.col-1]=null),e.row=null,e.col=null,!1)},l.getKeeper=function(){for(var e=0;e<l.move.players.length;e++){var t=l.move.players[e];if(0===t.row&&0===t.col)return t}return null},l.getSubst=function(){for(var e=new Array(i),t=0;t<l.move.players.length;t++){var n=l.move.players[t];n.row===-1&&(e[-n.col]=n)}return e},l.getAdjustments=function(){for(var e=[],t=0;t<l.move.adjustments.length;t++){var n=l.move.adjustments[t];!n.id&&n.markDeleted||e.push(n)}return e.length>0&&e.sort(function(e,t){return e.option.item-t.option.item}),e},l.addAdjustment=function(e,t){r.loadAdjustmentForm(e).then(function(n){if(n.data&&n.data.lines){l.option=e,l.adjustmentForm=n.data;var r=[];r[a.SET_PLAYER_INDICATOR]=[],r[a.SUBSTITUTE_INDICATOR]=[];for(var i=0;i<l.move.players.length;i++){var s=l.move.players[i];s.row===-1?r[a.SUBSTITUTE_INDICATOR].push(s.name):l.isPlayerSet(s)&&r[a.SET_PLAYER_INDICATOR].push(s.name)}for(var u=0;u<l.adjustmentForm.lines.length;u++)for(var c=l.adjustmentForm.lines[u],m=0;m<c.combos.length;m++)for(var p=c.combos[m],f=0;f<p.options.length;f++){var d=p.options[f];r[a.SET_PLAYER_INDICATOR].indexOf(d.label)>=0?d.label+=a.SET_PLAYER_INDICATOR:r[a.SUBSTITUTE_INDICATOR].indexOf(d.label)>=0&&(d.label+=a.SUBSTITUTE_INDICATOR)}t&&t(l.adjustmentForm),o.open("moveAction")}})},l.removeAdjustment=function(e){e.markDeleted=!e.markDeleted},l.saveAdjustment=function(){var e=new a,t=new e.Adjustment;t.option.item=l.option.item,t.option.page=l.option.page,t.option.text=l.option.text;for(var n=0;n<l.adjustmentForm.lines.length;n++)for(var o=l.adjustmentForm.lines[n],r=0;r<o.combos.length;r++){for(var i,s=o.combos[r],u=0;u<s.options.length;u++){var c=s.options[u];if(c.value===s.value){i=c.label.replace(a.SET_PLAYER_INDICATOR,"").replace(a.SUBSTITUTE_INDICATOR,"");break}}t.params[s.name]={value:s.value,text:i}}t.text=e.generateAdjustmentText(t),l.move.adjustments.push(t)};var s=function(e){l.move=e,l.move.players=e.sortPlayers();for(var t=0;t<l.move.players.length;t++){var n=l.move.players[t];n.row>0&&n.col>0&&(l.grid[n.row-1][n.col-1]=n)}};l.save=function(){for(var e=0,n=0;n<l.move.players.length;n++){var a=l.move.players[n];l.isPlayerSet(a)&&a.row>=0&&e++}e<11?t.alert("Es ist (vorläufig) nicht möglich die Zugabgabe zu speichern, solange nicht 11 Spieler aufgestellt sind!"):r.saveMove(l.move).then(function(){r.loadMove().then(s),o.open("moveCheck")})},l.load=function(e){return e?(r.loadMove(l.zat).then(s),void(l.zat=null)):(l.zat=l.move.zats[0].value,void o.open("moveLoad"))},r.loadMove().then(s)}]}),osApp.component("movePlayer",{templateUrl:"components/move/move.player.html",bindings:{player:"<object",onMove:"&",onRemove:"&"},controller:["$scope","$element","$document","$drag","$touch","$transform","$timeout","$interval","SharedState","Popup",function(e,t,n,o,r,a,l,i,s,u){var c=this,m=[];m.push(document.querySelector(".grid-container")),m.push(document.querySelector(".keeper-container")),m.push(document.querySelector(".subst-container"));var p=t[0].firstChild,f=p.getBoundingClientRect(),d=function(){if(null===c.player.row&&null===c.player.col){var e=document.querySelector(".selection-container");if(e)return function(t){t?(angular.element(e).addClass("moving"),angular.element(p).addClass("moving")):(angular.element(e).removeClass("moving"),angular.element(p).removeClass("moving"))}}return function(e){e?(angular.element(p).addClass("moving"),angular.element(p.nextElementSibling).addClass("moving")):(angular.element(p).removeClass("moving"),angular.element(p.nextElementSibling).removeClass("moving"))}}(),h={navbar:51,area:document.querySelector(".scroll-area"),height:document.querySelector(".scroll-area").scrollHeight,slow:{margin:25,offset:5},fast:{margin:12,offset:10},interval:300,offset:0,promise:null},g=!1,v={transform:function(e,t,n){h.promise&&(i.cancel(h.promise),h.promise=null);var o=function(){for(var e=0;e<m.length;e++)if(m[e]){var o=m[e].getBoundingClientRect();if(n.x>o.left&&n.x<o.right&&n.y>o.top&&n.y<o.bottom){var r=n.x-o.left,a=n.y-o.top;return t.translateX=o.left+(r-r%f.width)-f.left,t.translateY=o.top+(a-a%f.height)-f.top,null!==c.player.row&&null!==c.player.col&&(t.translateY+=h.offset),t}}return t.translateX=n.distanceX,t.translateY=n.distanceY,null!==c.player.row&&null!==c.player.col&&(t.translateY+=h.offset),t},r=function(){var e=0;return window.innerHeight>2*h.slow.margin&&(n.y<h.navbar+h.slow.margin&&h.area.scrollTop>=h.slow.offset?e=n.y<h.navbar+h.fast.margin&&h.area.scrollTop>=h.fast.offset?-h.fast.offset:-h.slow.offset:n.y>window.innerHeight-h.slow.margin&&(e=n.y>window.innerHeight-h.fast.margin?h.fast.offset:h.slow.offset,h.area.scrollTop+e>h.height-h.area.clientHeight&&(e=h.height-h.area.clientHeight-h.area.scrollTop))),e},l=function(){var t=r();h.offset+=t,h.area.scrollTop+=t;var n=o();return a.set(e,n),n};return 0!==r()?(h.promise=i(l,h.interval),l()):o()},start:function(e,t){g=!0,d(!0),s.turnOff("leftSwipe"),h.offset=0},move:function(e,t){},cancel:function(e,t){d(!1),g=!1,i.cancel(h.promise),h.promise=null},end:function(t,n){for(var o=!1,r=0;r<m.length;r++)if(m[r]){var a=m[r].getBoundingClientRect();if(t.x>a.left&&t.x<a.right&&t.y>a.top&&t.y<a.bottom){var s=Math.floor((t.x-a.left)/f.width)+1,u=Math.floor((t.y-a.top)/f.height)+1;1===r?(s=0,u=0):2===r&&(s=(s-1)*-1,u=-1),c.onMove({player:c.player,x:s,y:u})&&t.reset(),o=!0}}o||(null!==c.player.row&&null!==c.player.col?c.onRemove({player:c.player})&&t.reset():t.reset()),l(function(){d(!1),g=!1,e.$apply()},100),i.cancel(h.promise),h.promise=null}};o.bind(p,v,{}),r.bind(p,{start:function(e){g||(f=p.getBoundingClientRect(),d(!0))},cancel:function(e){g||d(!1)},end:function(t){g||(d(!1),u.open("modalPlayer",c.player),e.$apply())}},{})}]});